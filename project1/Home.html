<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAPSTERS : Ultrasonic SHM System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons for clean, modern symbols -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* --- ENHANCED NEUMORPHISM CONFIGURATION (FUTURISTIC 3D LOOK) --- */
        :root {
            /* DEEPER BACKGROUND GRADIENT FOR FUTURISTIC LIFT */
            --bg-start: #f0f4f8; /* Light blue/gray start */
            --bg-end: #e6eaf0;   /* Slightly darker end */
            --bg-light: #e6eaf0; /* Base element color */
            
            /* DEEPER SHADOWS FOR ENHANCED 3D EFFECT */
            --shadow-dark: #a9adb4; 
            --shadow-light: #ffffff; 

            /* PRIMARY COLOR: Deep, professional infrastructure blue */
            --primary-blue: #2a3e59;
            --primary-hover: #365072;
            --primary-pressed: #1e2c40;
        }
        body {
            font-family: 'Inter', sans-serif;
            /* Apply the subtle gradient background */
            background: linear-gradient(145deg, var(--bg-start), var(--bg-end));
            color: #374151; /* Gray 700 */
            scroll-behavior: smooth;
        }

        /* --- New App Layout Styles --- */
        #app-container {
            display: flex;
            min-height: 100vh; 
            padding-top: 5rem; 
        }
        #sidebar {
            width: 280px; 
            min-height: 100vh; 
            position: fixed;
            top: 5rem; 
            left: 0;
            z-index: 20;
            padding: 1.5rem 1rem;
            overflow-y: auto;
            background-color: var(--bg-light);
            box-shadow: 4px 0 8px rgba(0,0,0,0.05); 
        }
        #content-wrapper {
            margin-left: 280px; 
            flex-grow: 1;
            padding: 1rem 1.5rem 4rem; 
            overflow-y: auto; 
        }
        .sticky-header {
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 50;
            padding: 1rem 0; 
            border-radius: 0;
        }
        .app-view {
            display: none; 
            min-height: 70vh; 
        }
        .app-view.active {
            display: block;
        }
        
        /* Style sidebar links */
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            font-weight: 500;
            cursor: pointer;
            color: #374151;
        }
        .sidebar-link:hover {
            /* Deeper hover shadow */
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            color: var(--primary-blue);
        }
        .sidebar-link.active {
            background-color: var(--primary-blue); 
            color: white;
            /* Outset shadow for a floating effect */
            box-shadow: 6px 6px 12px var(--primary-pressed), -6px -6px 12px var(--primary-hover);
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: white; 
        }

        /* Mobile adjustments (Sidebar hides, content is full width) */
        @media (max-width: 1024px) {
            #sidebar {
                display: none;
            }
            #content-wrapper {
                margin-left: 0;
                padding-top: 1rem;
            }
            #app-container {
                padding-top: 5rem;
            }
        }
        /* --- End New App Layout Styles --- */

        /* Custom Neumorphic Styles (ENHANCED FOR DEPTH) */
        .neumorphic-card {
            border-radius: 1.5rem; /* rounded-3xl */
            background: var(--bg-light);
            /* DEEPER, MORE SCULPTED LOOK */
            box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
            transition: all 0.3s ease;
        }
        .neumorphic-button {
            border-radius: 1rem; /* rounded-xl */
            background: var(--bg-light);
            /* Standard pressable effect */
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .neumorphic-button:hover {
            box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light);
        }
        .neumorphic-button:active, .neumorphic-pressed {
            /* DEEPER INSET on active */
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .neumorphic-cta {
            background-color: var(--primary-blue);
            color: white;
            border-radius: 1rem; /* rounded-xl */
            /* Stronger CTA shadow for contrast */
            box-shadow: 6px 6px 12px var(--primary-pressed), -6px -6px 12px var(--primary-hover);
            transition: all 0.15s ease;
        }
        .neumorphic-cta:hover {
            background-color: var(--primary-hover);
            box-shadow: 8px 8px 16px var(--primary-pressed), -8px -8px 16px var(--primary-hover);
        }
        .neumorphic-cta:active {
            background-color: var(--primary-pressed);
            /* Stronger CTA inset on press */
            box-shadow: inset 4px 4px 8px #1e2c40, inset -4px -4px 8px #365072;
        }
        .neumorphic-input {
            border-radius: 0.75rem; /* rounded-lg */
            background: var(--bg-light);
            /* DEEPER INSET on inputs */
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            padding: 0.75rem 1rem;
            width: 100%;
            border: none;
            outline: none;
        }

        /* Chat Specific Styles */
        #chat-window {
            height: 300px;
            overflow-y: auto;
            border-radius: 1rem;
            /* Use a contained, subtle inset for chat window to look like a screen */
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            background-color: #f0f4f8;
        }
        .user-message {
            background-color: var(--primary-blue);
            color: white;
            border-radius: 1rem 1rem 0 1rem;
            max-width: 80%;
            margin-left: auto;
        }
        .ai-message {
            background-color: #ffffff;
            color: #374151;
            border-radius: 1rem 1rem 1rem 0;
            max-width: 80%;
            margin-right: auto;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Canvas Style - Retained subtle inset screen look */
        .sim-canvas {
            border-radius: 1rem;
            background-color: #ffffff;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }

        #coverage-canvas {
            background-color: #f0f4f8;
        }
        
        /* New Style for Metric Icons (using primary blue) */
        .metric-icon {
            color: var(--primary-blue);
        }
        
        /* Notification style fix */
        #notification-box {
            position: fixed;
            top: -100px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: top 0.3s ease-in-out, opacity 0.3s ease;
            opacity: 0;
            /* Floating Card Style */
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            background-color: var(--bg-start);
        }
        #notification-box.show {
            top: 6rem; 
            opacity: 1;
        }
    </style>
</head>
<body onload="lucide.createIcons()">

    <!-- Temporary Notification Box -->
    <div id="notification-box" class="neumorphic-card p-4 rounded-xl text-sm font-semibold text-gray-700 shadow-xl bg-white/90">
        <div class="flex items-center space-x-2">
            <i data-lucide="info" class="w-4 h-4 text-blue-500"></i>
            <span id="notification-message"></span>
        </div>
    </div>
    
    <!-- A. Header (Fixed Top Bar) -->
    <header id="header" class="sticky-header py-4 neumorphic-card rounded-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <!-- Logo -->
            <div class="flex items-center space-x-2 text-xl font-bold text-gray-800">
                <i data-lucide="zap" class="text-blue-600 w-6 h-6"></i>
                <span class="text-2xl tracking-tight" style="color: var(--primary-blue);">ZAPSTERS</span>
                <span class="hidden lg:inline text-sm font-medium text-gray-500 ml-4">| Ultrasonic SHM Dashboard</span>
            </div>

            <!-- CTA: Contact for Demo -->
            <button onclick="showNotification('Contact us for a full system demo and partnership opportunities.')" class="px-6 py-2 text-sm font-semibold neumorphic-cta">
                Contact for Demo
            </button>
        </div>
    </header>

    <!-- App Container Wrapper -->
    <div id="app-container" class="max-w-screen-xl mx-auto">
        
        <!-- B. Fixed Sidebar Navigation -->
        <nav id="sidebar" class="hidden lg:block">
            <h3 class="text-xs font-bold uppercase text-gray-500 mb-4">Core Modules</h3>
            
            <button class="sidebar-link active" data-view-id="dashboard" onclick="showView('dashboard', this)">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
            </button>

            <!-- FIX: Added ID to make 'Explore Now' button function correctly -->
            <button class="sidebar-link" data-view-id="metrics" onclick="showView('metrics', this)" id="metrics-sidebar-link">
                <i data-lucide="activity" class="w-5 h-5 mr-3"></i> Live NDT Data
            </button>

            <button class="sidebar-link" data-view-id="wave-analyzer" onclick="showView('wave-analyzer', this)">
                <i data-lucide="git-branch-plus" class="w-5 h-5 mr-3"></i> Wave Analyzer
            </button>

            <button class="sidebar-link" data-view-id="coverage-map" onclick="showView('coverage-map', this)">
                <i data-lucide="map" class="w-5 h-5 mr-3"></i> Coverage Map
            </button>

            <button class="sidebar-link" data-view-id="risk-planner" onclick="showView('risk-planner', this)">
                <i data-lucide="shield-half" class="w-5 h-5 mr-3"></i> Risk & Planner
            </button>

            <button class="sidebar-link" data-view-id="ai-diagnosis" onclick="showView('ai-diagnosis', this)">
                <i data-lucide="bot" class="w-5 h-5 mr-3"></i> AI Diagnostics
            </button>

            <button class="sidebar-link" data-view-id="optimization" onclick="showView('optimization', this)">
                <i data-lucide="trending-up" class="w-5 h-5 mr-3"></i> Optimization
            </button>

            <div class="h-px bg-gray-300 my-4 mx-2"></div>

            <h3 class="text-xs font-bold uppercase text-gray-500 mb-4">Support & Tools</h3>

            <button class="sidebar-link" data-view-id="library" onclick="showView('library', this)">
                <i data-lucide="library" class="w-5 h-5 mr-3"></i> Research Library
            </button>
            
            <button class="sidebar-link" data-view-id="chatbot" onclick="showView('chatbot', this)">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Expert Chat
            </button>
            
        </nav>
        
        <!-- C. Main Scrollable Content Area -->
        <div id="content-wrapper" class="lg:max-w-[calc(100%-280px)]">
            
            <!-- VIEW: 1. Dashboard (Hero + Core Features) -->
            <div id="view-dashboard" class="app-view active space-y-5">
                <div class="flex justify-between items-center border-b pb-4 mb-10">
                    <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-gray-900 leading-tight" style="color: var(--primary-blue);">
                        System Dashboard
                    </h1>
                    <button onclick="showGuide('dashboard')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                
                <!-- Hero Section (from old #home) -->
                <section class="pb-10 grid lg:grid-cols-2 gap-16 items-center">
                    <div class="space-y-6">
                        <h2 class="text-4xl font-extrabold tracking-tight text-gray-900">
                            Detect Cracks Early. Prevent Disasters.
                        </h2>
                        <p class="text-xl text-gray-600">
                            InfraScan Pro is a smart system identifying internal concrete flaws by analyzing ultrasonic wave delays, ensuring structural integrity and public safety.
                        </p>
                        <!-- FIXED: Now targets the actual sidebar link ID -->
                        <button onclick="document.getElementById('metrics-sidebar-link').click();" class="mt-4 px-8 py-3 text-lg font-bold neumorphic-cta">
                            Explore Now
                        </button>
                    </div>
                    
                    <div class="neumorphic-card p-4 mx-auto max-w-sm w-full lg:max-w-md">
                        <div >
                            <div>
                                <!-- Image tag for visual representation -->
                                <img src="img/img1.png" alt="Ultrasonic SHM System Diagram" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x300/e0e5ec/2a3e59?text=Ultrasonic+SHM+Diagram';">  
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Features Section (from old #features) -->
                <section class="pt-10">
                    <h3 class="text-3xl font-bold text-center mb-16 text-gray-800">Core Project Objectives</h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        
                        <div class="neumorphic-card p-6 text-center space-y-4">
                            <i data-lucide="library" class="w-10 h-10 text-indigo-500 mx-auto neumorphic-card p-3 rounded-xl"></i>
                            <h4 class="text-xl font-semibold text-gray-700">Research Library</h4>
                            <p class="text-gray-600 text-sm">Digital content on ultrasonic wave principles, sensor deployment, and NDT standards.</p>
                        </div>

                        <div class="neumorphic-card p-6 text-center space-y-4">
                            <i data-lucide="brain" class="w-10 h-10 text-red-500 mx-auto neumorphic-card p-3 rounded-xl"></i>
                            <h4 class="text-xl font-semibold text-gray-700">Crack AI Classification</h4>
                            <p class="text-gray-600 text-sm">Time-Frequency analysis using CNNs for accurate classification of microcrack severity.</p>
                        </div>

                        <div class="neumorphic-card p-6 text-center space-y-4">
                            <i data-lucide="messages-square" class="w-10 h-10 text-gray-500 mx-auto neumorphic-card p-3 rounded-xl"></i>
                            <h4 class="text-xl font-semibold text-gray-700">24/7 SHM Expert AI</h4>
                            <p class="text-gray-600 text-sm">AI-driven assistance for real-time problem-solving and immediate support on sensor readings.</p>
                        </div>

                        <div class="neumorphic-card p-6 text-center space-y-4">
                            <i data-lucide="circuit-board" class="w-10 h-10 text-purple-500 mx-auto neumorphic-card p-3 rounded-xl"></i>
                            <h4 class="text-xl font-semibold text-gray-700">Hardware Integration</h4>
                            <p class="text-gray-600 text-sm">Interface design involving Arduino/ESP32 for signal generation, acquisition, and reliable data logging.</p>
                        </div>
                    </div>
                </section>
            </div>


            <!-- VIEW: 2. Live NDT Data (old #metrics) -->
            <div id="view-metrics" class="app-view space-y-8">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">Live Ultrasonic Sensor Data</h2>
                    <button onclick="showGuide('metrics')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl">Input core NDT metrics below to observe instantaneous AI status interpretation. This simulates a real-time sensor reading across various physical and chemical parameters. The system is designed for long-term trend analysis.</p>

                <div class="neumorphic-card p-8 space-y-8 max-w-6xl mx-auto">
                    <div id="metric-viewer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-4 text-center">
                        
                        <!-- Icon colors changed to use metric-icon class (Primary Blue) -->
                        <div id="card-tof" class="neumorphic-card p-3 rounded-xl space-y-2">
                            <i data-lucide="clock" class="w-8 h-8 mx-auto metric-icon"></i>
                            <p class="text-sm font-medium text-gray-500">Time of Flight (TOF)</p>
                            <p id="metric-tof" class="text-xl font-bold text-blue-600">65 μs</p>
                            <p id="status-tof" class="text-xs text-green-600">Status: Fast/Optimal</p>
                        </div>

                        <div id="card-pv" class="neumorphic-card p-3 rounded-xl space-y-2">
                            <i data-lucide="gauge" class="w-8 h-8 mx-auto metric-icon"></i>
                            <p class="text-sm font-medium text-gray-500">Pulse Velocity (PV)</p>
                            <p id="metric-pv" class="text-xl font-bold text-indigo-600">4.2 km/s</p>
                            <p id="status-pv" class="text-xs text-green-600">Rating: Good Quality</p>
                        </div>
                        
                        <div id="card-attenuation" class="neumorphic-card p-3 rounded-xl space-y-2">
                            <i data-lucide="zap-off" class="w-8 h-8 mx-auto metric-icon"></i>
                            <p class="text-sm font-medium text-gray-500">Signal Attenuation</p>
                            <p id="metric-attenuation" class="text-xl font-bold text-yellow-700">12 dB</p>
                            <p id="status-attenuation" class="text-xs text-orange-500">Level: Moderate</p>
                        </div>
                        
                        <div id="card-impedance" class="neumorphic-card p-3 rounded-xl space-y-2">
                            <i data-lucide="scan" class="w-8 h-8 mx-auto metric-icon"></i>
                            <p class="text-sm font-medium text-gray-500">Acoustic Impedance Mismatch</p>
                            <p id="metric-impedance" class="text-xl font-bold text-violet-600">85%</p>
                            <p id="status-impedance" class="text-xs text-yellow-600">Level: Moderate Flaw</p>
                        </div>

                        <div id="card-chlorine" class="neumorphic-card p-3 rounded-xl space-y-2">
                            <i data-lucide="droplet" class="w-8 h-8 mx-auto metric-icon"></i>
                            <p class="text-sm font-medium text-gray-500">Chlorine Ion Conc.</p>
                            <p id="metric-chlorine" class="text-xl font-bold text-lime-600">0.05%</p>
                            <p id="status-chlorine" class="text-xs text-green-600">Risk: Negligible</p>
                        </div>

                        <div id="card-ph" class="neumorphic-card p-3 rounded-xl space-y-2">
                            <i data-lucide="flask-conical" class="w-8 h-8 mx-auto metric-icon"></i>
                            <p class="text-sm font-medium text-gray-500">Concrete pH Level</p>
                            <p id="metric-ph" class="text-xl font-bold text-pink-600">12.5</p>
                            <p id="status-ph" class="text-xs text-green-600">Risk: High Alkalinity</p>
                        </div>

                        <div id="card-depth" class="neumorphic-card p-3 rounded-xl space-y-2">
                            <i data-lucide="maximize-2" class="w-8 h-8 mx-auto metric-icon"></i>
                            <p class="text-sm font-medium text-gray-500">Crack Depth Estimate</p>
                            <p id="metric-depth" class="text-xl font-bold text-orange-600">0.0 mm</p>
                            <p id="status-depth" class="text-xs text-green-600">Target: Clear</p>
                        </div>
                        
                    </div>

                    <form id="instant-metrics-form" class="flex flex-wrap items-end justify-center gap-4 pt-4 border-t border-gray-300">
                        <div class="w-full sm:w-1/4">
                            <label for="input-inst-tof" class="block text-xs font-medium mb-1">Enter TOF (μs)</label>
                            <input type="number" id="input-inst-tof" value="70" class="neumorphic-input text-sm" required>
                        </div>
                        <div class="w-full sm:w-1/4">
                            <label for="input-inst-pv" class="block text-xs font-medium mb-1">Enter PV (km/s)</label>
                            <input type="number" id="input-inst-pv" value="4.3" step="0.1" class="neumorphic-input text-sm" required>
                        </div>
                        <div class="w-full sm:w-1/4">
                            <label for="input-inst-attenuation" class="block text-xs font-medium mb-1">Enter Attenuation (dB)</label>
                            <input type="number" id="input-inst-attenuation" value="10" class="neumorphic-input text-sm" required>
                        </div>
                        <button type="submit" id="simulate-metrics-btn" class="w-full sm:w-auto px-6 py-2 font-bold neumorphic-cta">
                            <i data-lucide="activity" class="w-4 h-4 mr-2 inline-block"></i> Simulate Reading
                        </button>
                    </form>
                </div>
            </div>

            <!-- VIEW: 3. Wave Analyzer (old #wave-analyzer) -->
            <div id="view-wave-analyzer" class="app-view space-y-8">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">Ultrasonic Waveform Analyzer</h2>
                    <button onclick="showGuide('wave-analyzer')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl">Manipulate structural parameters (Crack Size, Material Damping) to visualize their direct effect on the Time-Domain Waveform and the resulting Frequency Spectrum (FFT).</p>

                <div class="neumorphic-card p-8 max-w-6xl mx-auto space-y-6">
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="text-xl font-semibold text-gray-700">Simulation Controls (P-Wave)</h3>
                            
                            <div>
                                <label for="sim-crack-size" class="block text-sm font-medium mb-1 flex justify-between">
                                    <span>Simulated Crack Size (mm):</span>
                                    <span id="val-crack-size" class="font-bold text-red-600">0.0 mm</span>
                                </label>
                                <input type="range" id="sim-crack-size" value="0" min="0" max="5" step="0.1" oninput="runWaveSimulation(); draw3DCoverage();" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <div>
                                <label for="sim-frequency" class="block text-sm font-medium mb-1 flex justify-between">
                                    <span>Transducer Frequency (kHz):</span>
                                    <span id="val-frequency" class="font-bold text-blue-600">50 kHz</span>
                                </label>
                                <input type="range" id="sim-frequency" value="50" min="20" max="100" oninput="runWaveSimulation()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <div>
                                <label for="sim-dampening" class="block text-sm font-medium mb-1 flex justify-between">
                                    <span>Material Dampening (Low Quality):</span>
                                    <span id="val-dampening" class="font-bold text-gray-600">Low</span>
                                </label>
                                <input type="range" id="sim-dampening" value="3" min="1" max="5" step="1" oninput="runWaveSimulation()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <p class="text-xs text-gray-500 mt-4">Note: Larger cracks cause delay and high-frequency energy loss.</p>
                        </div>

                        <div class="md:col-span-2 space-y-4">
                            <div class="neumorphic-card p-4 rounded-xl">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">1. Time Domain Waveform (Signal Delay)</h4>
                                <canvas id="time-domain-canvas" width="600" height="150" class="sim-canvas w-full"></canvas>
                            </div>

                            <div class="neumorphic-card p-4 rounded-xl">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">2. Frequency Spectrum (FFT - High-Frequency Loss)</h4>
                                <canvas id="frequency-canvas" width="600" height="150" class="sim-canvas w-full"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="text-center pt-4 border-t border-gray-300">
                        <p id="wave-analysis-output" class="text-xl font-bold text-red-600">Current Status: Healthy signal.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: 4. Coverage Map (old #coverage-map) -->
            <div id="view-coverage-map" class="app-view space-y-8">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">3D Ultrasonic Sensor Coverage Map</h2>
                    <button onclick="showGuide('coverage-map')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl">Visualize the wave path (direct vs. detour) in real-time. The increased Time of Flight (TOF) for the detour path is the primary indicator of internal damage. Select a scenario below to load pre-set crack conditions.</p>

                <div class="neumorphic-card p-8 max-w-5xl mx-auto space-y-6">
                    
                    <div class="grid lg:grid-cols-3 gap-6">
                        <canvas id="coverage-canvas" width="600" height="300" class="sim-canvas w-full lg:col-span-2"></canvas>
                        
                        <div class="neumorphic-card p-4 space-y-3 bg-gray-100 lg:col-span-1">
                            <h4 class="text-lg font-bold text-gray-800">Live NDT Feedback</h4>
                            <div class="border-b border-gray-300 pb-2">
                                <p class="text-sm font-medium text-gray-600">Direct Path TOF (Healthy)</p>
                                <p id="live-tof-direct" class="text-xl font-bold text-green-600">0 μs</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600">Observed TOF (Simulated)</p>
                                <p id="live-tof-observed" class="text-xl font-bold text-red-600">0 μs</p>
                            </div>
                            <p id="coverage-status" class="text-xs text-gray-500 pt-2">Awaiting analysis...</p>
                        </div>
                    </div>

                    <!-- Controls: New Scenario Selector + Sliders -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-1">
                            <label for="scenario-select" class="block text-sm font-medium mb-1">Select Structural Scenario:</label>
                            <select id="scenario-select" class="neumorphic-input cursor-pointer" onchange="loadCoverageScenario(this.value)">
                                <option value="healthy">1. Healthy Concrete (Minimal Cracks)</option>
                                <option value="microcrack">2. Micro-Crack Detected (Low Delay)</option>
                                <option value="corrosion">3. Rebar Corrosion Damage (Medium Risk)</option>
                                <option value="largevoid">4. Large Void/Honeycombing (High Delay)</option>
                                <option value="lowstrength">5. Low Strength/High Porosity (Widespread)</option>
                                <option value="critical">6. Critical Delamination (Max Risk)</option>
                            </select>
                        </div>
                        <div>
                            <label for="sensor-distance" class="block text-sm font-medium mb-1 flex justify-between">
                                <span>Sensor Distance (L, cm):</span>
                                <span id="val-sensor-distance" class="font-bold text-blue-600">30 cm</span>
                            </label>
                            <input type="range" id="sensor-distance" value="30" min="10" max="80" step="5" oninput="draw3DCoverage();" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label for="crack-position" class="block text-sm font-medium mb-1 flex justify-between">
                                <span>Simulated Flaw Position (a, cm from T):</span>
                                <span id="val-crack-position" class="font-bold text-red-600">40 cm</span>
                            </label>
                            <input type="range" id="crack-position" value="40" min="0" max="80" step="5" oninput="draw3DCoverage();" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                    <button onclick="startWaveAnimation()" class="w-full py-3 font-bold neumorphic-cta">
                        <i data-lucide="play" class="w-5 h-5 mr-2 inline-block"></i> Run Wave Animation
                    </button>
                </div>
            </div>

            <!-- VIEW: 5. Risk & Planner (old #risk-analyzer + #planner) -->
            <div id="view-risk-planner" class="app-view space-y-12">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">Structural Risk Assessment & Maintenance Planner</h2>
                    <button onclick="showGuide('risk-planner')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl">Input field data, ultrasonic, and material chemistry readings to get an AI-powered risk score, then generate a maintenance action plan. Accurate input leads to precise maintenance scheduling.</p>

                <!-- Risk Analyzer (from old #risk-analyzer) -->
                <section class="space-y-6">
                    <h3 class="text-3xl font-semibold text-gray-700">1. Analyze Structural Risk</h3>
                    <div class="grid lg:grid-cols-2 gap-12 items-start">
                        
                        <div class="neumorphic-card p-8 space-y-6">
                            <h4 class="text-2xl font-semibold text-gray-700 mb-4">Input Structural & Wave Data</h4>
                            
                            <form id="demo-form" class="space-y-4">
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="input-structure" class="block text-sm font-medium mb-1">Structure Type</label>
                                        <select id="input-structure" class="neumorphic-input cursor-pointer">
                                            <option value="pillar">Bridge/Pillar</option>
                                            <option value="beam">Building Beam</option>
                                            <option value="slab">Road/Slab</option>
                                            <option value="foundation">Foundation</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="input-mix-grade" class="block text-sm font-medium mb-1">Concrete Mix Grade</label>
                                        <select id="input-mix-grade" class="neumorphic-input cursor-pointer">
                                            <option value="m20">M20 (Standard)</option>
                                            <option value="m30">M30 (Good)</option>
                                            <option value="m40">M40 (High Strength)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label for="input-tof" class="block text-sm font-medium mb-1">Time of Flight (μs)</label>
                                        <input type="number" id="input-tof" value="120" class="neumorphic-input" required placeholder="Optimal < 80">
                                    </div>
                                    <div>
                                        <label for="input-pv" class="block text-sm font-medium mb-1">Pulse Velocity (km/s)</label>
                                        <input type="number" id="input-pv" value="3.5" step="0.1" class="neumorphic-input" required placeholder="Optimal > 4.0">
                                    </div>
                                    <div>
                                        <label for="input-attenuation" class="block text-sm font-medium mb-1">Attenuation (dB)</label>
                                        <input type="number" id="input-attenuation" value="15" class="neumorphic-input" required>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="input-chlorine-risk" class="block text-sm font-medium mb-1">Chlorine Ion Conc. (% wt cement)</label>
                                        <input type="number" id="input-chlorine-risk" value="0.2" step="0.05" class="neumorphic-input" required placeholder="Critical > 0.4%">
                                    </div>
                                    <div>
                                        <label for="input-ph-risk" class="block text-sm font-medium mb-1">Concrete pH Level</label>
                                        <input type="number" id="input-ph-risk" value="10.5" step="0.5" class="neumorphic-input" required placeholder="Carbonation Risk < 9.5">
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label for="input-thickness" class="block text-sm font-medium mb-1">Section Thickness (cm)</label>
                                        <input type="number" id="input-thickness" value="30" class="neumorphic-input" required>
                                    </div>
                                    <div>
                                        <label for="input-crack-width" class="block text-sm font-medium mb-1">Observed Crack Width (mm)</label>
                                        <input type="number" id="input-crack-width" value="0.2" step="0.1" class="neumorphic-input" required>
                                    </div>
                                    <div>
                                        <label for="input-cover-depth" class="block text-sm font-medium mb-1">Rebar Cover Depth (mm)</label>
                                        <input type="number" id="input-cover-depth" value="25" class="neumorphic-input" required placeholder="Min 20mm">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="input-repair-cost" class="block text-sm font-medium mb-1">Estimated Inspection Cost (₹, mock)</label>
                                    <input type="number" id="input-repair-cost" value="15000" class="neumorphic-input" required>
                                </div>

                                <button type="submit" id="recommend-btn" class="w-full mt-6 py-3 font-bold text-lg neumorphic-cta">
                                    Analyze Structural Risk
                                </button>
                            </form>
                        </div>

                        <div id="initial-output-placeholder" class="neumorphic-card p-8 flex items-center justify-center h-full min-h-[300px]">
                            <div class="text-center text-gray-500">
                                <i data-lucide="target" class="w-10 h-10 mx-auto mb-2"></i>
                                <p>Input your parameters and click 'Analyze Structural Risk' to see the diagnostic results.</p>
                            </div>
                        </div>

                        <div id="demo-output" class="neumorphic-card p-8 space-y-6 hidden">
                            <h4 class="text-2xl font-semibold text-gray-800 flex items-center space-x-2">
                                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                                <span>AI Structural Risk Assessment</span>
                            </h4>
                            
                            <div class="space-y-4">
                                <div class="neumorphic-card p-4 rounded-xl">
                                    <p class="text-sm font-medium text-gray-500">Structural Condition Grade:</p>
                                    <p id="output-grade" class="text-2xl font-bold text-blue-600">...</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="neumorphic-card p-4 rounded-xl">
                                        <p class="text-sm font-medium text-gray-500">Estimated Crack Depth (cm):</p>
                                        <p id="output-depth" class="text-xl font-bold text-purple-600">...</p>
                                    </div>
                                    <div class="neumorphic-card p-4 rounded-xl">
                                        <p class="text-sm font-medium text-gray-500">Priority Repair Cost (₹, mock):</p>
                                        <p id="output-cost" class="text-xl font-bold text-red-600">...</p>
                                    </div>
                                </div>
                                <div class="neumorphic-card p-4 rounded-xl">
                                    <p class="text-sm font-medium text-gray-500">Overall Structural Risk Score:</p>
                                    <p id="output-risk" class="text-2xl font-bold text-red-600">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <div class="h-px bg-gray-300 my-10"></div>

                <!-- Planner Section (from old #planner) -->
                <section class="space-y-6">
                    <h3 class="text-3xl font-semibold text-gray-700">2. Generate Maintenance Plan</h3>
                    <div class="grid lg:grid-cols-2 gap-12 items-start">
                        
                        <div class="neumorphic-card p-8 space-y-6">
                            <h4 class="text-2xl font-semibold text-gray-700 mb-4">Select Component and Risk Level</h4>
                            <label for="component-select" class="block text-sm font-medium mb-1">Structural Component:</label>
                            <select id="component-select" class="neumorphic-input cursor-pointer">
                                <option value="pillar">Pillar/Column</option>
                                <option value="beam">Building Beam</option>
                                <option value="slab">Slab/Deck</option>
                                <option value="foundation">Foundation</option>
                            </select>

                            <label for="risk-select" class="block text-sm font-medium mb-1">Diagnosed Risk Level:</label>
                            <select id="risk-select" class="neumorphic-input cursor-pointer">
                                <option value="low">Low Risk (Grade A/B)</option>
                                <option value="moderate">Moderate Risk (Grade C)</option>
                                <option value="high">High Risk (Grade D/E)</option>
                                <option value="critical">Critical Risk (Immediate Action)</option>
                            </select>

                            <button onclick="viewStructurePlan()" id="planner-btn" class="w-full mt-6 py-3 font-bold text-lg neumorphic-cta">
                                View Maintenance Plan
                            </button>
                        </div>

                        <div id="planner-output" class="neumorphic-card p-8 space-y-6">
                            <h4 class="text-2xl font-semibold text-gray-800 flex items-center space-x-2">
                                <i data-lucide="calendar-check" class="w-6 h-6"></i>
                                <span id="planner-component-title">Maintenance Plan</span>
                            </h4>
                            
                            <div class="space-y-3">
                                <p class="text-sm font-medium text-gray-500">Current Priority Level:</p>
                                <p id="planner-priority" class="text-xl font-bold text-gray-800">Awaiting Selection...</p>
                            </div>
                            <div class="space-y-3">
                                <p class="text-sm font-medium text-gray-500">Required Actions (Next 30 Days):</p>
                                <ul id="planner-tasks" class="list-disc pl-5 text-base text-gray-600 space-y-1">
                                    <li>Select a component and risk level to generate the action plan.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
            </div>


            <!-- VIEW: 6. AI Diagnostics (old #diagnosis + #scalogram) -->
            <div id="view-ai-diagnosis" class="app-view space-y-12">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">AI Signal Diagnostics</h2>
                    <button onclick="showGuide('ai-diagnosis')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl">This module provides AI-based diagnosis for signal anomalies and simulates the image processing pipeline used by the CNN crack classification models. Deep learning enables accurate microcrack classification.</p>

                <!-- Diagnosis Simulator (from old #diagnosis) -->
                <section class="space-y-6">
                    <h3 class="text-3xl font-semibold text-gray-700">1. Anomaly Diagnosis & Action Plan</h3>
                    <div class="grid lg:grid-cols-2 gap-12 items-start">
                        
                        <div class="neumorphic-card p-8 space-y-6">
                            <h4 class="text-2xl font-semibold text-gray-700 mb-4">Select Wave Anomaly</h4>
                            <label for="symptom-select" class="block text-sm font-medium mb-1">Observed Signal Issue:</label>
                            <select id="symptom-select" class="neumorphic-input cursor-pointer">
                                <option value="wave_delay">High Time of Flight (Wave Delay)</option>
                                <option value="attenuation">Excessive Signal Attenuation (Energy Loss)</option>
                                <option value="echoes">Multiple Echoes/Reflections (Internal Voids)</option>
                                <option value="low_pv">Low Pulse Velocity (Weak Concrete)</option>
                                <option value="loss">Signal Loss/No Reception (Full Blockage)</option>
                            </select>

                            <button onclick="runDiagnosis()" id="diagnosis-btn" class="w-full mt-6 py-3 font-bold text-lg neumorphic-cta">
                                Run AI Signal Analysis
                            </button>
                        </div>

                        <div id="diagnosis-output" class="neumorphic-card p-8 space-y-6">
                            <h4 class="text-2xl font-semibold text-gray-800 flex items-center space-x-2">
                                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                                <span id="diagnosis-title">AI Anomaly Report</span>
                            </h4>
                            
                            <div class="space-y-3">
                                <p class="text-sm font-medium text-gray-500">Likely Structural Cause:</p>
                                <p id="diagnosis-cause" class="text-xl font-bold text-gray-800">Awaiting Simulation...</p>
                            </div>
                            <div class="space-y-3">
                                <p class="text-sm font-medium text-gray-500">Recommended Action:</p>
                            <p id="diagnosis-action" class="text-base text-gray-600">Select an anomaly and click 'Run AI Signal Analysis' to see immediate mitigation steps.</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <div class="h-px bg-gray-300 my-10"></div>

                <!-- Scalogram Simulator (from old #scalogram) -->
                <section class="space-y-6">
                    <h3 class="text-3xl font-semibold text-gray-700">2. AI Scalogram Viewer Simulation (CNN Input)</h3>
                    <p class="text-gray-600">Simulates the AI's core process: converting the time-series data into a visual frequency map (Scalogram) for CNN processing.</p>

                    <div class="neumorphic-card p-8 max-w-4xl mx-auto space-y-6">
                        <h4 class="text-2xl font-semibold text-gray-800 flex items-center space-x-2">
                            <i data-lucide="signal-high" class="w-6 h-6"></i> Signal State Simulator
                        </h4>
                        
                        <div class="flex flex-col sm:flex-row justify-around items-end space-y-4 sm:space-y-0 sm:space-x-4">
                            <div class="flex-1 w-full">
                                <label for="signal-type" class="block text-sm font-medium mb-1">Select Waveform Condition:</label>
                                <select id="signal-type" class="neumorphic-input cursor-pointer">
                                    <option value="healthy">Healthy Concrete (Fast TOF)</option>
                                    <option value="microcrack">Microcrack Detected (Wave Delay/Attenuation)</option>
                                    <option value="severe">Severe Flaw/Void (High Attenuation/Scattering)</option>
                                </select>
                            </div>
                            <button onclick="generateScalogram()" class="neumorphic-cta px-6 py-3 font-bold text-lg w-full sm:w-auto">
                                Analyze Waveform
                            </button>
                        </div>
                        
                        <div id="scalogram-output" class="neumorphic-card p-6 text-center space-y-4">
                            <h4 class="text-xl font-bold text-gray-700">Simulated AI Classification Result:</h4>
                            <div class="bg-gray-200 h-40 w-full rounded-lg flex items-center justify-center text-gray-500">
                                <p id="scalogram-visual">Simulated Scalogram Image / Time-Frequency Map</p>
                            </div>
                            <p id="ai-prediction" class="text-2xl font-bold text-purple-600">Awaiting Analysis...</p>
                            <p id="ai-confidence" class="text-sm text-gray-600">Confidence: 0%</p>
                        </div>
                    </div>
                </section>
            </div>


            <!-- VIEW: 7. Optimization (old #optimization) -->
            <div id="view-optimization" class="app-view space-y-8">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">Inspection Efficiency Calculator</h2>
                    <button onclick="showGuide('optimization')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl">Allocate your 100% inspection budget across key phases. The optimal split for microcrack detection is 50% Sensor Density (Data Quality), 30% AI Processing, 20% Manual Verification.</p>

                <div class="grid lg:grid-cols-2 gap-12 items-start">
                    <div class="neumorphic-card p-8 space-y-6">
                        <h3 class="text-2xl font-semibold text-gray-700">Allocate Inspection Budget (%)</h3>
                        
                        <form id="optimization-form" class="space-y-4">
                            <div>
                                <label for="budget-density" class="block text-sm font-medium mb-1 flex justify-between">
                                    <span>Sensor Placement Density (Data Quality) (%)</span>
                                    <span id="val-density" class="font-bold text-blue-600">30%</span>
                                </label>
                                <input type="range" id="budget-density" value="30" min="0" max="100" oninput="updateAllocation()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                            </div>
                            <div>
                                <label for="budget-ai" class="block text-sm font-medium mb-1 flex justify-between">
                                    <span>AI Processing Time (CNN Analysis) (%)</span>
                                    <span id="val-ai" class="font-bold text-red-600">30%</span>
                                </label>
                                <input type="range" id="budget-ai" value="30" min="0" max="100" oninput="updateAllocation()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                            </div>
                            <div>
                                <label for="budget-manual" class="block text-sm font-medium mb-1 flex justify-between">
                                    <span>Manual Verification/Reports (%)</span>
                                    <span id="val-manual" class="font-bold text-gray-600">30%</span>
                                </label>
                                <input type="range" id="budget-manual" value="30" min="0" max="100" oninput="updateAllocation()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                            </div>

                            <div class="neumorphic-card p-4 rounded-xl text-center font-bold">
                                <p class="text-sm font-medium text-gray-500">Remaining Budget %</p>
                                <p id="remaining-budget" class="text-2xl text-yellow-600">10%</p>
                            </div>
                            
                            <button type="submit" id="optimize-btn" class="w-full mt-6 py-3 font-bold text-lg neumorphic-cta">
                                Calculate Detection Accuracy
                            </button>
                        </form>
                    </div>

                    <div id="optimization-output" class="neumorphic-card p-8 space-y-6">
                        <h3 class="text-2xl font-semibold text-gray-800 flex items-center space-x-2">
                            <i data-lucide="calculator" class="w-6 h-6"></i>
                            <span>Efficiency Results</span>
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="neumorphic-card p-4 rounded-xl bg-white/70">
                                    <p class="text-sm font-medium text-gray-500">Detection Accuracy (Simulated):</p>
                                    <p id="opt-accuracy" class="text-xl font-bold text-purple-600">0%</p>
                                </div>
                                <div class="neumorphic-card p-4 rounded-xl bg-white/70">
                                    <p class="text-sm font-medium text-gray-500">Estimated Cost Savings (Mock):</p>
                                    <p id="opt-savings" class="text-xl font-bold text-blue-600">₹ 0</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="neumorphic-card p-4 rounded-xl bg-white/70">
                                    <p class="text-sm font-medium text-gray-500">Inspection Time Reduction:</p>
                                    <p id="opt-reduction" class="text-xl font-bold text-red-600">0%</p>
                                </div>
                                <div class="neumorphic-card p-4 rounded-xl bg-white/70">
                                    <p class="text-sm font-medium text-gray-500">Anomaly Detection Rate:</p>
                                    <p id="opt-rate" class="text-xl font-bold text-lime-600">0%</p>
                                </div>
                            </div>
                            
                            <div id="opt-visualization" class="space-y-3 pt-4 border-t border-gray-300">
                                <p class="text-sm font-medium text-gray-700 font-bold mb-2">Budget Allocation (Actual vs. Optimal 50:30:20)</p>
                                <div class="space-y-1">
                                    <span class="text-xs text-gray-600">Sensor Density (Target: 50%)</span>
                                    <div id="vis-density-bar" class="h-3 rounded-full bg-blue-300" style="width: 0%"></div>
                                </div>
                                <div class="space-y-1">
                                    <span class="text-xs text-gray-600">AI Processing (Target: 30%)</span>
                                    <div id="vis-ai-bar" class="h-3 rounded-full bg-red-300" style="width: 0%"></div>
                                </div>
                                <div class="space-y-1">
                                    <span class="text-xs text-gray-600">Manual Verification (Target: 20%)</span>
                                    <div id="vis-manual-bar" class="h-3 rounded-full bg-gray-300" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <p id="opt-message" class="text-base text-gray-600 pt-2">Adjust the sliders to find the optimal resource allocation for maximum accuracy!</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- VIEW: 8. Research Library (old #library) -->
            <div id="view-library" class="app-view space-y-8">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">NDT Research & Case Studies Library</h2>
                    <button onclick="showGuide('library')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl text-left">Explore categorized modules covering the core technologies and research behind this project. This library contains the full theoretical foundation.</p>

                <div class="max-w-4xl mx-auto">
                    <!-- Filter Tabs -->
                    <div class="flex flex-wrap justify-center space-x-4 mb-8">
                        <button id="tab-ultrasonic" class="filter-tab neumorphic-button active" onclick="setLibraryContent('ultrasonic', this)">
                            <i data-lucide="waveform" class="w-4 h-4 mr-2 inline-block"></i> Ultrasonic Testing
                        </button>
                        <button id="tab-ai" class="filter-tab neumorphic-button" onclick="setLibraryContent('ai', this)">
                            <i data-lucide="bot" class="w-4 h-4 mr-2 inline-block"></i> AI/ML in SHM
                        </button>
                        <button id="tab-materials" class="filter-tab neumorphic-button" onclick="setLibraryContent('materials', this)">
                            <i data-lucide="package" class="w-4 h-4 mr-2 inline-block"></i> Material Science
                        </button>
                    </div>

                    <div class="neumorphic-card p-8 rounded-3xl space-y-4">
                        <h3 id="library-title" class="text-2xl font-semibold text-gray-800">Ultrasonic Testing Principles</h3>
                        <p id="library-description" class="text-gray-600 text-left">Learn about ultrasonic wave propagation in concrete, focusing on Time of Flight (TOF) and Pulse Velocity (PV) methods. Understand how a crack acts as a wave scatterer and how signal attenuation correlates with internal damage.</p>
                        <ul id="library-list" class="list-disc pl-5 text-gray-700 space-y-1 text-xs text-left">
                            <li>Module 1: P-Wave vs. S-Wave Velocity in Cementitious Materials</li>
                            <li>Module 2: Direct, Semi-Direct, and Indirect Measurement Setup</li>
                            <li>Module 3: Transducer Calibration and Couplant Use</li>
                        </ul>
                        <button onclick="displayDocumentation()" class="neumorphic-cta px-6 py-2 text-sm font-semibold rounded-xl">
                            View Detailed Documentation
                        </button>
                    </div>

                    <div id="documentation-pane" class="neumorphic-card p-8 space-y-6 mt-12 hidden min-h-[500px] bg-gray-100 text-left">
                        <h3 id="doc-title" class="text-3xl font-bold doc-header text-gray-800 border-b-2 border-gray-400 pb-4"></h3>
                        <div id="doc-content" class="space-y-6">
                            <!-- Content injected by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- VIEW: 9. SHM Expert AI Chatbot (old #chatbot) -->
            <div id="view-chatbot" class="app-view space-y-8">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-4xl font-bold tracking-tight text-gray-900">SHM Expert AI Assistant</h2>
                    <button onclick="showGuide('chatbot')" class="neumorphic-button text-sm px-4 py-2 flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Guide</span>
                    </button>
                </div>
                <p class="text-gray-600 max-w-3xl">Ask the AI a quick question about concrete NDT, ultrasonic wave behavior, or sensor setup (e.g., "Why does high TOF indicate a crack?"). This assistant is trained on the full technical documentation.</p>

                <div class="lg:w-2/3 mx-auto neumorphic-card p-6 md:p-8 space-y-6">
                    <div id="chat-window" class="p-4 space-y-4 flex flex-col">
                        <div class="ai-message p-3 shadow-md">
                            <p class="font-semibold text-sm mb-1 text-blue-700">InfraScan AI:</p>
                            <p>Hello! I'm your Structural Health Monitoring Companion. How can I assist you with ultrasonic readings or NDT today?</p>
                        </div>
                    </div>

                    <form id="chat-form" class="flex space-x-4">
                        <input type="text" id="chat-input" placeholder="Ask your structural health question..." class="neumorphic-input flex-grow" required>
                        <button type="submit" class="neumorphic-cta px-4 py-2 font-semibold rounded-xl">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- O. Footer (Now positioned below the main app container content) -->
    <footer class="mt-20 pt-10 pb-6 neumorphic-card rounded-none border-t border-gray-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center space-y-6">
            <p class="text-gray-700 font-semibold">
                ZAPSTERS
            </p>
            <p class="text-gray-600 text-sm">
                Developing the Future of Structural Health Monitoring.
            </p>
            
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-8 text-gray-600">
                <a href="mailto:zapsters23@gmail.com" class="hover:text-gray-900 transition duration-150 flex items-center space-x-2">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                    <span>zapsters23@gmail.com</span>
                </a>
                <div class="flex space-x-4">
                    <button class="neumorphic-button p-2 text-gray-500 hover:text-gray-900 rounded-xl"><i data-lucide="facebook" class="w-5 h-5"></i></button>
                    <button class="neumorphic-button p-2 text-gray-500 hover:text-gray-900 rounded-xl"><i data-lucide="twitter" class="w-5 h-5"></i></button>
                    <button class="neumorphic-button p-2 text-gray-500 hover:text-gray-900 rounded-xl"><i data-lucide="linkedin" class="w-5 h-5"></i></button>
                </div>
            </div>

            <p class="text-xs text-gray-400 pt-4">
                &copy; 2025 Zapsters. All rights reserved.
            </p>
        </div>
    </footer>

    <script>
        // Global utility variables and initializations
        let notificationTimeoutId = null;
        let waveAnimationProgress = 0;
        let waveAnimationId = null;

        // NEW GUIDE FEATURE DATA
        const guides = {
            dashboard: "This is the main overview. The 'Explore Now' button takes you directly to the Live Data to start monitoring. Use the sidebar to navigate the full suite of NDT tools.",
            metrics: "LIVE NDT DATA: This section simulates real-time sensor readings. Input values in the form to see instantaneous status assessments. Look for 'red' statuses which indicate high risk. Use the input fields to simulate a reading.",
            'wave-analyzer': "WAVE ANALYZER: Manipulate the sliders (Crack Size, Frequency, Dampening) to visualize their effect on the Time-Domain Waveform and Frequency Spectrum. This helps understand wave physics.",
            'coverage-map': "COVERAGE MAP: Visualize the wave path in 3D. Choose a **Structural Scenario** to load preset crack conditions. Click 'Run Wave Animation' to see how the wave is forced into a longer, detoured path.",
            'risk-planner': "RISK & PLANNER: Use the **Analyze Structural Risk** form to combine NDT data (TOF, PV) with material chemistry (Chlorine, pH) to generate an AI-powered risk score and estimated crack depth. Then, use the **Maintenance Plan** section to generate recommended actions based on the risk level.",
            'ai-diagnosis': "AI DIAGNOSTICS: In Section 1, select a **Signal Anomaly** to receive an immediate AI-generated cause and mitigation plan. Section 2 simulates the conversion of raw data into a Scalogram image, which is the input for the CNN crack classification model.",
            optimization: "INSPECTION EFFICIENCY: Allocate your 100% inspection budget across Sensor Density, AI Processing, and Manual Verification. Click **Calculate Detection Accuracy** to see the simulated impact of your resource allocation against the optimal split (50:30:20).",
            library: "RESEARCH LIBRARY: Explore categorized documentation on Ultrasonic Testing, AI/ML, and Material Science. Use the tabs to filter content and click **View Detailed Documentation** for the full technical papers.",
            chatbot: "EXPERT CHAT: Ask the AI Assistant specific, technical questions about concrete NDT, ultrasonic principles, or sensor setup. The AI is trained on the full project documentation."
        };

        /**
         * Displays contextual help for the current view using the notification box.
         * @param {string} viewId - The ID of the current view.
         */
        function showGuide(viewId) {
            const guideText = guides[viewId] || "No specific guide available for this section.";
            showNotification(`GUIDE: ${guideText}`);
        }
        
        // NEW: Data structure for predefined coverage scenarios
        const coverageScenarios = {
            healthy: { name: "Healthy Concrete (Minimal Cracks)", size: 0.1, position: 40, distance: 30, pv: 4.5, tof: 65, attenuation: 8 },
            microcrack: { name: "Micro-Crack Detected (Low Delay)", size: 1.5, position: 20, distance: 40, pv: 4.0, tof: 100, attenuation: 15 },
            corrosion: { name: "Rebar Corrosion Damage (Medium Risk)", size: 0.8, position: 50, distance: 50, pv: 3.8, tof: 135, attenuation: 18 },
            largevoid: { name: "Large Void/Honeycombing (High Delay)", size: 3.0, position: 25, distance: 30, pv: 3.5, tof: 120, attenuation: 25 },
            lowstrength: { name: "Low Strength Concrete (Widespread)", size: 0.5, position: 10, distance: 30, pv: 3.0, tof: 160, attenuation: 10 },
            critical: { name: "Critical Delamination (Max Risk)", size: 5.0, position: 55, distance: 60, pv: 2.5, tof: 200, attenuation: 35 },
        };

        /**
         * Core function to switch between the application views.
         * Hides all other views and activates the selected one.
         * @param {string} viewId - The ID of the view to show (e.g., 'dashboard', 'metrics').
         * @param {HTMLElement} element - The clicked navigation element.
         */
        function showView(viewId, element) {
            // 1. Hide all views and remove 'active' class from links
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.remove('active');
            });
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });

            // 2. Show the target view and set 'active' class on link
            const targetView = document.getElementById(`view-${viewId}`);
            if (targetView) {
                targetView.classList.add('active');
            }
            if (element) {
                element.classList.add('active');
            }

            // 3. Scroll content wrapper to the top for a clean view transition
            const contentWrapper = document.getElementById('content-wrapper');
            if (contentWrapper) {
                contentWrapper.scrollTop = 0;
            }
            
            // Recreate Lucide icons for the newly visible content
            lucide.createIcons();
            
            // FIX: Updated notification message to be more descriptive
            const friendlyName = (element && element.textContent) ? element.textContent.trim() : viewId.replace('-', ' ').toUpperCase();
            showNotification(`Mapsd to: ${friendlyName}`);
        }
        
        // --- Utility Functions (Retained) ---

        function showNotification(message) {
            const box = document.getElementById('notification-box');
            
            if (notificationTimeoutId) {
                clearTimeout(notificationTimeoutId);
            }

            document.getElementById('notification-message').textContent = message;
            box.classList.add('show');
            
            notificationTimeoutId = setTimeout(() => {
                box.classList.remove('show');
                notificationTimeoutId = null;
            }, 3000);
        }

        // --- Dynamic Metric Status Logic (Retained) ---
        function updateMetricStatus(metricId, value, minOptimal, maxOptimal, unit) {
            const statusEl = document.getElementById(`status-${metricId}`);
            const metricEl = document.getElementById(`metric-${metricId}`);
            
            if (!statusEl || !metricEl) {
                return;
            }

            let statusClass = 'text-green-600';
            let statusText = 'Status: Optimal';

            const isBadHigh = (metricId === 'tof' || metricId === 'attenuation' || metricId === 'chlorine' || metricId === 'depth' || metricId === 'impedance');
            const isBadLow = (metricId === 'pv' || metricId === 'ph');

            if (isBadHigh) {
                if (value > maxOptimal) {
                    statusClass = 'text-red-600';
                    statusText = (metricId === 'chlorine') ? 'Risk: High Corrosion' : (metricId === 'impedance') ? 'Flaw: High Mismatch' : 'Status: High Risk';
                } else if (value > minOptimal) {
                    statusClass = 'text-yellow-600';
                    statusText = (metricId === 'chlorine') ? 'Risk: Caution' : (metricId === 'impedance') ? 'Flaw: Moderate Mismatch' : 'Status: Caution/Alert';
                } else {
                    statusText = (metricId === 'chlorine') ? 'Risk: Negligible' : (metricId === 'impedance') ? 'Flaw: Minimal Mismatch' : 'Status: Optimal';
                }
            } else if (isBadLow) {
                if (value < minOptimal) {
                    statusClass = 'text-red-600';
                    statusText = (metricId === 'ph') ? 'Risk: Carbonation' : 'Rating: Poor Quality';
                } else if (value < maxOptimal) {
                    statusClass = 'text-yellow-600';
                    statusText = (metricId === 'ph') ? 'Risk: Marginal' : 'Rating: Acceptable';
                } else {
                    statusText = (metricId === 'ph') ? 'Risk: High Alkalinity' : 'Rating: Excellent';
                }
            }
            
            if (metricId === 'temp') statusText = 'Trend: Stable';

            statusEl.className = `text-xs ${statusClass}`;
            statusEl.textContent = statusText;
            
            // Update metric value color based on status
            metricEl.className = 'text-xl font-bold'; 
            metricEl.classList.add(statusClass.replace('text', 'text').replace('-600', '-700'));
        }

        /**
         * Simulates live metrics based on direct input and mirrors relevant data to the dashboard.
         */
        function runInstantSimulation(e) {
            if (e) e.preventDefault();

            // Get inputs from Section D form
            const TOF_in = parseFloat(document.getElementById('input-inst-tof').value);
            const PV_in = parseFloat(document.getElementById('input-inst-pv').value);
            const Attenuation_in = parseFloat(document.getElementById('input-inst-attenuation').value);

            // --- Calculation of Derived Metrics (Simulated SHM Logic) ---
            const basePV = 4.0; 
            const baseTOF = 60; // Optimal TOF for a given fixed distance (mock)

            const tofPenalty = Math.max(0, TOF_in - baseTOF) * 0.5;
            const pvPenalty = Math.max(0, basePV - PV_in) * 5;
            const totalPenalty = (tofPenalty + pvPenalty + (Attenuation_in - 10) * 1.5);

            const derivedImpedance = Math.min(Math.max(10 + totalPenalty * 2, 5), 95); // 5 to 95%
            const derivedDepth = Math.max(0, (totalPenalty * 0.05)); // Max 5mm

            // Hardcoded/Environmental Data for simulation completeness
            const temp = 28.5; 
            const chlorine = 0.08; 
            const ph = 12.0; 
            
            const metrics = [
                { id: 'tof', value: TOF_in, unit: " μs", minOptimal: 80, maxOptimal: 120, isBadHigh: true },
                { id: 'pv', value: PV_in, unit: " km/s", minOptimal: 3.8, maxOptimal: 4.5, isBadHigh: false },
                { id: 'attenuation', value: Attenuation_in, unit: " dB", minOptimal: 10, maxOptimal: 18, isBadHigh: true },
                { id: 'impedance', value: derivedImpedance, unit: "%", minOptimal: 10, maxOptimal: 50, isBadHigh: true },
                { id: 'chlorine', value: chlorine, unit: "%", minOptimal: 0.1, maxOptimal: 0.4, isBadHigh: true },
                { id: 'ph', value: ph, unit: "", minOptimal: 9.5, maxOptimal: 11.5, isBadHigh: false },
                { id: 'depth', value: derivedDepth, unit: " mm", minOptimal: 0.5, maxOptimal: 2.0, isBadHigh: true },
                { id: 'temp', value: temp, unit: " °C", minOptimal: 20, maxOptimal: 30, isBadHigh: true },
            ];

            // Update Metric Cards in Section D
            metrics.forEach(m => {
                const value = parseFloat(m.value.toFixed(m.id === 'chlorine' ? 2 : 1));
                
                const metricEl = document.getElementById(`metric-${m.id}`);
                if (metricEl) metricEl.textContent = value + m.unit;
                
                updateMetricStatus(m.id, value, m.minOptimal, m.maxOptimal, m.unit);
            });

            // Populate Risk Analyzer Form (Section H) with these instant readings
            document.getElementById('input-tof').value = TOF_in;
            document.getElementById('input-pv').value = PV_in;
            document.getElementById('input-attenuation').value = Attenuation_in;
            // The chemistry metrics are hardcoded for this simulation but would typically come from a sensor
            document.getElementById('input-chlorine-risk').value = chlorine; 
            document.getElementById('input-ph-risk').value = ph; 
            
            // --- UI Feedback ---
            
            const button = document.getElementById('simulate-metrics-btn');
            if (button) {
                button.classList.add('neumorphic-pressed');
                setTimeout(() => { button.classList.remove('neumorphic-pressed'); }, 300);
            }
            if (e && e.isTrusted) {
                showNotification(`Instant Sensor Simulation Complete. TOF: ${TOF_in} μs, PV: ${PV_in} km/s.`);
            }
        }
        
        // --- Coverage Map Scenario Logic (RETAINED) ---

        /**
         * Loads and applies a predefined structural scenario to sliders and inputs.
         * @param {string} scenarioKey - Key from coverageScenarios.
         */
        function loadCoverageScenario(scenarioKey) {
            const scenario = coverageScenarios[scenarioKey];
            if (!scenario) return;

            // 1. Update Wave Analyzer sliders (crack size and dampening/frequency are linked)
            document.getElementById('sim-crack-size').value = scenario.size;
            // Dampening is loosely tied to severity (lower PV/higher attenuation implies more dampening)
            document.getElementById('sim-dampening').value = Math.max(1, Math.min(5, Math.round(scenario.attenuation / 8)));
            // Keep frequency constant unless part of scenario

            // 2. Update Coverage Map sliders
            document.getElementById('sensor-distance').value = scenario.distance;
            const crackPositionSlider = document.getElementById('crack-position');
            if (crackPositionSlider && scenario.position) crackPositionSlider.value = scenario.position;

            // 3. Update Live NDT Data inputs to match scenario's severity
            document.getElementById('input-inst-tof').value = scenario.tof;
            document.getElementById('input-inst-pv').value = scenario.pv;
            document.getElementById('input-inst-attenuation').value = scenario.attenuation;
            
            // NOTE: Chlorine/pH are left at defaults unless scenario specifies.

            // 4. Run simulations to refresh all linked visualizations (Wave Analyzer, NDT Live Metrics, Risk Score)
            runWaveSimulation();
            // Call runInstantSimulation to update the Live NDT Data card values
            runInstantSimulation(null); 
            stopWaveAnimation();
            draw3DCoverage();

            // Set the scenario selector value correctly (especially on load)
            const selector = document.getElementById('scenario-select');
            if (selector) selector.value = scenarioKey;

            showNotification(`Loaded scenario: ${scenario.name}`);
        }

        // --- Library Logic (Retained) ---
        const libraryContent = {
            ultrasonic: {
                title: "Ultrasonic Testing Principles",
                description: "Learn about ultrasonic wave propagation in concrete, focusing on Time of Flight (TOF) and Pulse Velocity (PV) methods. Understand how a crack acts as a wave scatterer and how signal attenuation correlates with internal damage.",
                modules: ["Module 1: P-Wave vs. S-Wave Velocity in Cementitious Materials", "Module 2: Direct, Semi-Direct, and Indirect Measurement Setup", "Module 3: Transducer Calibration and Couplant Use"],
                full_documentation: `
                    <p class="text-lg font-bold text-gray-700">Non-Destructive Testing (NDT) with Ultrasonics</p>
                    <p>Ultrasonic Pulse Velocity (UPV) is a primary NDT technique for concrete. In healthy concrete, the ultrasonic wave (P-wave) travels rapidly (4.5 km/s or higher). The presence of a crack or void forces the wave to travel a detour (a longer path), leading to a higher Time of Flight (TOF) and a lower Pulse Velocity (PV), directly correlating with internal structural damage.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-4">Wave Types and Measurement Setup</h4>
                    <ul class="list-disc pl-6 text-base space-y-2">
                        <li><strong>P-Wave Velocity (Compressional Wave):</strong> The speed of this wave is the primary indicator of concrete quality and presence of gross flaws.</li>
                        <li><strong>Transducer Setup:</strong> Direct transmission is the most sensitive method, placing the transmitter and receiver on opposite faces of the structure, maximizing energy transfer and accuracy.</li>
                        <li><strong>Couplant:</strong> Essential to fill the minute air gaps between the transducer and the rough concrete surface, preventing signal loss.</li>
                    </ul>
                    
                    <p class="text-lg font-bold text-gray-700 mt-6">Signal Processing Pipeline</p>
                    <p>The raw signal received by the transducer is digitized by the Arduino/ESP32. This noisy, low-voltage signal requires significant conditioning using filters and amplification before the characteristic features (TOF, amplitude) can be reliably extracted by Python libraries like <strong>SciPy</strong>.</p>
                `
            },
            ai: {
                title: "AI/ML in Structural Health Monitoring (SHM)",
                description: "Deep dive into using deep learning networks like VGG16 and MobileNetV2 to classify ultrasonic time-frequency images (scalograms). AI models enhance accuracy in identifying microcracks vs. normal variations.",
                modules: ["Module 1: Creating Scalograms from Raw Waveforms", "Module 2: Introduction to CNN Architectures for Classification", "Module 3: Real-time Anomaly Detection Algorithms"],
                full_documentation: `
                    <p class="text-lg font-bold text-gray-700">Deep Learning for Microcrack Detection</p>
                    <p>Traditional TOF analysis is effective for large flaws, but <strong>microcracks</strong> require highly sensitive analysis of the entire waveform profile. Our project addresses this using Non-linear Ultrasonic techniques combined with Deep Learning.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-4">The Scalogram/CNN Approach (L. Cheng et al.)</h4>
                    <ul class="list-disc pl-6 text-base space-y-2">
                        <li><strong>Conversion to Scalogram:</strong> Raw time-series ultrasonic data is converted into a Time-Frequency domain image (a Scalogram) using wavelet transformation. This image visually represents how signal frequency and energy evolve over time.</li>
                        <li><strong>CNN Classification:</strong> Convolutional Neural Networks (<strong>VGG16 and MobileNetV2</strong>) are highly effective at image classification. We use them to analyze the Scalogram images and accurately classify the concrete status as 'Healthy', 'Microcrack', or 'Severe Flaw'.</li>
                        <li><strong>Accuracy:</strong> The underlying research achieves over 94% accuracy in detecting internal microcracks, far surpassing linear methods.</li>
                    </ul>

                    <p class="text-lg font-bold text-gray-700 mt-6">Role of MobileNetV2</p>
                    <p>MobileNetV2, specifically designed for mobile and embedded applications, allows the AI classification to be deployed efficiently on lighter hardware, supporting the system's objective of real-time, resilient monitoring.</p>
                `
            },
            materials: {
                title: "Concrete Material Science & Degradation",
                description: "Explore concrete mix grades (M20, M30, M40), water-cement ratios, and common degradation types like carbonation, sulfate attack, and rebar corrosion. Understanding the material helps interpret NDT results.",
                modules: ["Module 1: Understanding Concrete Mix Design", "Module 2: Corrosion Mechanisms and Prevention", "Module 3: Non-Linear Wave Behavior in Damaged Concrete"],
                full_documentation: `
                    <p class="text-lg font-bold text-gray-700">Factors Affecting Ultrasonic Velocity</p>
                    <p>Ultrasonic Pulse Velocity (PV) is directly linked to the modulus of elasticity and density of the concrete. Low PV indicates lower compressive strength (e.g., in M20 concrete) or the presence of density-reducing elements like voids or microcracks.</p>
                    
                    <h4 class="text-xl font-semibold text-gray-700 mt-4">Common Degradation Types</h4>
                    <ul class="list-disc pl-6 text-base space-y-2">
                        <li><strong>Corrosion:</strong> Expansion of steel reinforcement (rebar) due to rust causes internal stress, leading to cracking (spalling). Our system detects these internal stress fractures early.</li>
                        <li><strong>Alkali-Aggregate Reaction (AAR):</strong> A slow chemical reaction causing expansion and pattern cracking, which significantly reduces the structural integrity and PV readings over time.</li>
                        <li><strong>Honeycombing:</strong> Large internal voids due to improper vibration or compaction, leading to massive signal scattering and attenuation, instantly flagging a poor-quality component.</li>
                    </ul>
                    
                    <p class="text-lg font-bold text-gray-700 mt-6">Importance of Water-Cement Ratio</p>
                    <p>The water-cement ratio is the most critical factor influencing strength and porosity. A high ratio (more water) leads to porous concrete, lower PV, and higher vulnerability to water ingress and long-term degradation.</p>
                `
            }
        };

        let currentLibraryCategory = 'ultrasonic';

        function setLibraryContent(category, element) {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active', 'neumorphic-pressed');
            });
            // Use querySelector instead of element.classList to prevent errors when called on load
            if (element) {
                 element.classList.add('active', 'neumorphic-pressed');
            } else {
                 document.querySelector(`#tab-${category}`).classList.add('active', 'neumorphic-pressed');
            }
            
            currentLibraryCategory = category;

            const content = libraryContent[category];
            const libraryTitle = document.getElementById('library-title');
            const libraryDescription = document.getElementById('library-description');
            
            if (libraryTitle) libraryTitle.textContent = content.title;
            if (libraryDescription) libraryDescription.textContent = content.description;
            
            const ul = document.getElementById('library-list');
            if (ul) {
                ul.innerHTML = ''; 
                content.modules.forEach(module => {
                    const li = document.createElement('li');
                    li.textContent = module;
                    ul.appendChild(li);
                });
            }
            
            const docPane = document.getElementById('documentation-pane');
            if (docPane) docPane.classList.add('hidden');
            lucide.createIcons(); 
        }

        function displayDocumentation() {
            const content = libraryContent[currentLibraryCategory];
            const pane = document.getElementById('documentation-pane');
            const docTitle = document.getElementById('doc-title');
            const docContent = document.getElementById('doc-content');

            if (pane && docTitle && docContent) {
                docTitle.textContent = `${content.title} - Full Technical Overview`;
                docContent.innerHTML = content.full_documentation;
                
                pane.classList.remove('hidden');
                showNotification(`Displaying full documentation for ${content.title}.`);
                
                pane.scrollIntoView({ behavior: 'smooth' });
            } else {
                console.error("Documentation pane elements not found.");
            }
        }


        // --- Crack Severity & Risk Analyzer Logic (REFACTORED) ---
        /**
         * Calculates the structural risk score based on current inputs in the Risk Planner form.
         * @param {Event} e - The form submission event (can be null if silent).
         * @param {boolean} isSilent - If true, prevents UI updates and notifications.
         * @returns {{score: number, grade: string, color: string}}
         */
        function analyzeStructuralRisk(e, isSilent = false) {
            if (e) e.preventDefault();

            // Get values from Risk & Planner form (View 5)
            const TOF = parseFloat(document.getElementById('input-tof').value);
            const PV = parseFloat(document.getElementById('input-pv').value);
            const Attenuation = parseFloat(document.getElementById('input-attenuation').value);
            const Thickness = parseFloat(document.getElementById('input-thickness').value);
            const CrackWidth = parseFloat(document.getElementById('input-crack-width').value);
            const Cost = parseFloat(document.getElementById('input-repair-cost').value);
            const MixGrade = document.getElementById('input-mix-grade').value;
            const ChlorineRisk = parseFloat(document.getElementById('input-chlorine-risk').value); 
            const PhRisk = parseFloat(document.getElementById('input-ph-risk').value); 
            const CoverDepth = parseFloat(document.getElementById('input-cover-depth').value); 
            
            let conditionGrade = "Unknown (E)";
            let riskScore = 0;
            
            // 1. Base PV Assessment (30 points max)
            if (PV >= 4.0) { riskScore += 10; conditionGrade = "Excellent (A)"; } 
            else if (PV >= 3.5) { riskScore += 30; conditionGrade = "Good (B)"; } 
            else if (PV >= 3.0) { riskScore += 60; conditionGrade = "Moderate (C)"; } 
            else { riskScore += 90; conditionGrade = "Poor (D)"; }
            
            // 2. TOF and Attenuation Penalty (50 points max)
            if (TOF > 120) riskScore += 30; // Severe delay
            else if (TOF > 80) riskScore += 15;
            
            if (Attenuation > 20) riskScore += 20; // High attenuation
            else if (Attenuation > 15) riskScore += 10;
            
            // 3. Material Chemistry Penalty (40 points max)
            if (ChlorineRisk > 0.4) riskScore += 25; 
            else if (ChlorineRisk > 0.2) riskScore += 10;
            if (PhRisk < 9.5) riskScore += 15; 
            else if (PhRisk < 11.5) riskScore += 5;
            if (CoverDepth < 20) riskScore += 10;
            else if (CoverDepth < 30) riskScore += 3;

            // 4. Crack Width & Mix Grade Multipliers
            if (CrackWidth > 0.5) riskScore *= 1.3;
            else if (CrackWidth > 0.2) riskScore *= 1.1;
            if (MixGrade === 'm40') riskScore *= 0.9; 
            else if (MixGrade === 'm20') riskScore *= 1.1; 

            riskScore = Math.min(Math.round(riskScore), 100);

            let expectedDepthCm = (Thickness * 0.01) * (1 + (TOF * 0.005) + (Attenuation * 0.01));
            expectedDepthCm = Math.max(Math.min(expectedDepthCm, Thickness / 2), 0.1); 
            const repairPriorityCost = Math.round(Cost * (1 + (riskScore / 50)));

            let riskColor;
            if (riskScore >= 80) {
                conditionGrade = "Critical (E)";
                riskColor = "text-red-600";
            } else if (riskScore >= 50) {
                conditionGrade = "High (D)";
                riskColor = "text-orange-600";
            } else if (riskScore >= 30) {
                riskColor = "text-yellow-600";
            } else {
                riskColor = "text-green-600";
            }

            // --- UI Update (only if not silent) ---
            if (!isSilent) {
                const outputEl = document.getElementById('demo-output');
                const placeholderEl = document.getElementById('initial-output-placeholder');
                const gradeEl = document.getElementById('output-grade');
                const riskEl = document.getElementById('output-risk');
                const depthEl = document.getElementById('output-depth');
                const costEl = document.getElementById('output-cost');

                if (placeholderEl) placeholderEl.classList.add('hidden');
                if (outputEl) outputEl.classList.remove('hidden');

                if (gradeEl) {
                    gradeEl.textContent = conditionGrade;
                    gradeEl.className = 'text-2xl font-bold'; 
                    gradeEl.classList.add(riskColor);
                }
                if (riskEl) {
                    riskEl.textContent = `${riskScore}%`;
                    riskEl.classList.remove('text-red-600', 'text-orange-600', 'text-yellow-600', 'text-green-600');
                    riskEl.classList.add(riskColor);
                }
                if (depthEl) depthEl.textContent = expectedDepthCm.toFixed(2) + " cm";
                if (costEl) costEl.textContent = "₹ " + repairPriorityCost.toLocaleString();
                    
                const button = document.getElementById('recommend-btn');
                if (button) {
                    button.classList.add('neumorphic-pressed');
                    setTimeout(() => { button.classList.remove('neumorphic-pressed'); }, 300);
                }
                if (e && e.isTrusted) {
                    showNotification(`Risk Analysis complete. Condition: ${conditionGrade}. Risk: ${riskScore}%.`);
                }
            }
            
            return { score: riskScore, grade: conditionGrade, color: riskColor };
        }

        // Hook up the form submit listener to the refactored function
        document.getElementById('demo-form').addEventListener('submit', analyzeStructuralRisk);

        // --- Wave Analyzer Logic (Retained) ---

        function drawTimeDomain(canvas, crackSize, frequency, dampening) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerY = height / 2;

            ctx.clearRect(0, 0, width, height);
            
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            for (let i = 1; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(30, height / 4 * i);
                ctx.lineTo(width - 10, height / 4 * i);
                ctx.stroke();
            }
            for (let i = 1; i < 6; i++) {
                ctx.beginPath();
                ctx.moveTo(30 + (width - 40) / 5 * i, 10);
                ctx.lineTo(30 + (width - 40) / 5 * i, height - 10);
                ctx.stroke();
            }

            ctx.strokeStyle = '#ccc';
            ctx.beginPath();
            ctx.moveTo(30, centerY); 
            ctx.lineTo(width - 10, centerY); 
            ctx.lineTo(width - 10, centerY - 5);
            ctx.moveTo(width - 10, centerY);
            ctx.lineTo(width - 10, centerY + 5);
            ctx.moveTo(30, centerY);
            ctx.lineTo(30, 10); 
            ctx.stroke();

            const cycles = 5; 
            const samples = 600;
            const timeSpan = 0.0005; 
            const simulatedFrequency = frequency * 1000;

            const initialAmplitude = 50;
            const crackDampingFactor = 0.005 * crackSize * (dampening / 5); 
            
            const delayMicroseconds = (crackSize * 20) + (dampening * 5); 
            const delaySamples = Math.round((delayMicroseconds / (timeSpan * 1000000)) * samples);

            ctx.beginPath();
            ctx.strokeStyle = '#2a3e59';
            ctx.lineWidth = 2;
            
            let firstPeakX = 0;
            const plotAreaWidth = width - 40;

            for (let i = 0; i < samples; i++) {
                let x = 30 + (i / samples) * plotAreaWidth;
                let t = (i / samples) * timeSpan;
                let amplitude;
                
                if (i < delaySamples) {
                    amplitude = 0; 
                } else {
                    let adjustedT = t - (delaySamples / samples) * timeSpan;
                    let envelope = initialAmplitude * Math.exp(-crackDampingFactor * i * 0.01);
                    amplitude = envelope * Math.sin(2 * Math.PI * simulatedFrequency * adjustedT * cycles);
                    
                    if (firstPeakX === 0 && Math.abs(amplitude) > 5) {
                        firstPeakX = x;
                    }
                }

                if (i === 0) {
                    ctx.moveTo(x, centerY - amplitude);
                } else {
                    ctx.lineTo(x, centerY - amplitude);
                }
            }

            ctx.stroke();

            const tofMarkerX = firstPeakX > 0 ? firstPeakX : 30 + delaySamples * (plotAreaWidth / samples);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(tofMarkerX, 10);
            ctx.lineTo(tofMarkerX, height - 10);
            ctx.stroke();
            ctx.fillStyle = 'red';
            ctx.font = '10px Inter';
            ctx.fillText(`TOF: ${delayMicroseconds.toFixed(0)} μs`, tofMarkerX + 5, 20);

            ctx.fillStyle = '#374151';
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Time (μs)', width - 30, centerY + 20); 
            ctx.textAlign = 'left';
            ctx.fillText('Amp', 5, 15); 
        }

        function drawFrequencySpectrum(canvas, crackSize, frequency, dampening) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const baseLevel = height - 10;
            const maxBarHeight = height - 30;

            ctx.clearRect(0, 0, width, height);
            
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(30, baseLevel - maxBarHeight * 0.5);
            ctx.lineTo(width - 10, baseLevel - maxBarHeight * 0.5);
            ctx.stroke();

            ctx.strokeStyle = '#ccc';
            ctx.beginPath();
            ctx.moveTo(30, baseLevel); 
            ctx.lineTo(width - 10, baseLevel);
            ctx.moveTo(30, baseLevel);
            ctx.lineTo(30, 10); 
            ctx.stroke();

            const numBins = 10;
            const plotAreaWidth = width - 40;
            const barWidth = plotAreaWidth / (numBins + 1);
            const centralFrequencyBin = Math.round((frequency - 20) / 8); 
            
            const highFrequencyLoss = (crackSize * 0.1) * (dampening * 0.2); 

            for (let i = 0; i < numBins; i++) {
                let x = 30 + (i + 1) * barWidth;
                let barHeight;
                let color;
                
                const currentFreq = 20 + i * 8; 

                if (i === centralFrequencyBin) {
                    barHeight = maxBarHeight * 0.8 * (1 - (dampening * 0.1));
                    color = '#2563eb'; 
                } else if (i > centralFrequencyBin) {
                    let attenuation = Math.pow(0.5, (i - centralFrequencyBin) / 2); 
                    barHeight = maxBarHeight * 0.5 * attenuation * (1 - highFrequencyLoss);
                    color = '#dc2626'; 
                } else {
                    barHeight = maxBarHeight * 0.3;
                    color = '#10b981'; 
                }
                
                barHeight = Math.max(barHeight, 5); 

                ctx.fillStyle = color;
                ctx.fillRect(x, baseLevel - barHeight, barWidth * 0.8, barHeight);
                
                ctx.fillStyle = '#374151';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                const label = `${currentFreq}k`;
                ctx.fillText(label, x + barWidth * 0.4, baseLevel + 10);
            }
            
            ctx.fillStyle = '#374151';
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Frequency (kHz)', width - 30, baseLevel + 20); 
            ctx.textAlign = 'left';
            ctx.fillText('Mag.', 5, 15); 

            const outputEl = document.getElementById('wave-analysis-output');
            let statusMessage;
            if (crackSize > 3) {
                 statusMessage = `CRITICAL: Severe flaw (${crackSize.toFixed(1)}mm) confirmed. Massive high-frequency loss.`;
                 outputEl.className = 'text-xl font-bold text-red-600';
            } else if (crackSize > 1) {
                statusMessage = `ALERT: Microcrack detected (${crackSize.toFixed(1)}mm). Noticeable signal delay and high-frequency dampening.`;
                outputEl.className = 'text-xl font-bold text-yellow-600';
            } else {
                statusMessage = `HEALTHY: Clear signal path. Minimal high-frequency loss and low delay.`;
                outputEl.className = 'text-xl font-bold text-green-600';
            }
            if (outputEl) outputEl.textContent = statusMessage;
        }

        function runWaveSimulation() {
            const crackSize = parseFloat(document.getElementById('sim-crack-size').value);
            const frequency = parseFloat(document.getElementById('sim-frequency').value);
            const dampening = parseFloat(document.getElementById('sim-dampening').value);

            const valCrackSize = document.getElementById('val-crack-size');
            const valFrequency = document.getElementById('val-frequency');
            const valDampening = document.getElementById('val-dampening');
            
            if (valCrackSize) valCrackSize.textContent = `${crackSize.toFixed(1)} mm`;
            if (valFrequency) valFrequency.textContent = `${frequency.toFixed(0)} kHz`;
            const dampeningLabels = {1: 'Low', 2: 'Mod-Low', 3: 'Moderate', 4: 'Mod-High', 5: 'High'};
            if (valDampening) valDampening.textContent = dampeningLabels[dampening];

            const timeCanvas = document.getElementById('time-domain-canvas');
            const freqCanvas = document.getElementById('frequency-canvas');
            
            if (timeCanvas) drawTimeDomain(timeCanvas, crackSize, frequency, dampening);
            if (freqCanvas) drawFrequencySpectrum(freqCanvas, crackSize, frequency, dampening);
        }

        // --- 3D Coverage Map Logic (Retained) ---

        function stopWaveAnimation() {
            if (waveAnimationId) {
                cancelAnimationFrame(waveAnimationId);
                waveAnimationId = null;
            }
        }

        function startWaveAnimation() {
            stopWaveAnimation();
            waveAnimationProgress = 0; 
            showNotification('Starting real-time wave propagation simulation...');
            
            const canvas = document.getElementById('coverage-canvas');
            if (!canvas) return;
            
            draw3DCoverage(0); 
            
            const speedFactor = 0.15; // Retained from original
            
            function animate() {
                waveAnimationProgress += 1; 
                
                const crackSize = parseFloat(document.getElementById('sim-crack-size').value);
                const distanceCm = parseInt(document.getElementById('sensor-distance').value);
                
                const detourMultiplier = crackSize > 0.5 ? 1.15 : 1.0; 
                const maxCm = distanceCm * detourMultiplier;

                if (waveAnimationProgress > 500) { 
                    stopWaveAnimation();
                    return;
                }

                if (waveAnimationProgress > maxCm * 5) { 
                     waveAnimationProgress = maxCm * 5;
                     stopWaveAnimation();
                     showNotification('Wave received by the receiver (R). Analysis Complete.');
                     return;
                }
                
                draw3DCoverage(waveAnimationProgress);
                waveAnimationId = requestAnimationFrame(animate);
            }
            waveAnimationId = requestAnimationFrame(animate);
        }

        function draw3DCoverage(animationProgress = 0) {
            const canvas = document.getElementById('coverage-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            ctx.clearRect(0, 0, W, H);
            
            const distanceCm = parseInt(document.getElementById('sensor-distance').value);
            const crackPositionCm = parseInt(document.getElementById('crack-position').value);
            const crackSize = parseFloat(document.getElementById('sim-crack-size').value);

            const maxDistance = 80;
            const scale = (W - 100) / maxDistance; 
            const paddingX = 50;
            const blockHeight = 150; 
            const perspectiveOffset = 15; 

            const startX = paddingX;
            const startY = H - 50;
            const endX = startX + distanceCm * scale;
            const sensorY = startY - (blockHeight / 2);
            
            const healthyPV = 4.0; 
            const directPathDistance = distanceCm * 10; 
            const detourPathDistance = distanceCm * 1.15 * 10;
            const directPathTOF = (directPathDistance / healthyPV).toFixed(0); 
            const detourPathTOF = (detourPathDistance / healthyPV).toFixed(0);

            const liveTofDirectEl = document.getElementById('live-tof-direct');
            const liveTofObservedEl = document.getElementById('live-tof-observed');
            const coverageStatusEl = document.getElementById('coverage-status');

            if (liveTofDirectEl) liveTofDirectEl.textContent = `${directPathTOF} μs`;
            
            let crackFound = false;
            let currentStatus = 'Awaiting analysis...';

            if (crackPositionCm > 0 && crackPositionCm < distanceCm && crackSize > 0.5) {
                crackFound = true;
                currentStatus = `ALERT: Crack forces ${((detourPathTOF / directPathTOF) * 100 - 100).toFixed(1)}% longer path.`;
                if (liveTofObservedEl) {
                    liveTofObservedEl.textContent = `${detourPathTOF} μs`;
                    liveTofObservedEl.classList.add('text-red-600');
                    liveTofObservedEl.classList.remove('text-green-600');
                }
            } else {
                currentStatus = `HEALTHY: Direct path clear.`;
                if (liveTofObservedEl) {
                    liveTofObservedEl.textContent = `${directPathTOF} μs`;
                    liveTofObservedEl.classList.remove('text-red-600');
                    liveTofObservedEl.classList.add('text-green-600');
                }
            }
            if (coverageStatusEl) coverageStatusEl.textContent = currentStatus;

            
            function drawBlockFace(fillColor, strokeColor) {
                ctx.fillStyle = fillColor;
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = 1.5;
                ctx.fillRect(startX, startY - blockHeight, distanceCm * scale, blockHeight);
                
                ctx.fillStyle = '#c5c8cf';
                ctx.beginPath();
                ctx.moveTo(startX, startY - blockHeight);
                ctx.lineTo(startX + perspectiveOffset, startY - blockHeight - perspectiveOffset);
                ctx.lineTo(endX + perspectiveOffset, startY - blockHeight - perspectiveOffset);
                ctx.lineTo(endX, startY - blockHeight);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#96999e';
                ctx.beginPath();
                ctx.moveTo(endX, startY - blockHeight);
                ctx.lineTo(endX + perspectiveOffset, startY - blockHeight - perspectiveOffset);
                ctx.lineTo(endX + perspectiveOffset, startY - perspectiveOffset);
                ctx.lineTo(endX, startY);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                ctx.strokeRect(startX, startY - blockHeight, distanceCm * scale, blockHeight); 
            }

            drawBlockFace('#a6a9ad', '#808080');
            
            ctx.strokeStyle = '#cc3333'; 
            ctx.lineWidth = 2;
            const rebarYTopFront = startY - blockHeight + 20;
            const rebarYBottomFront = startY - 20;
            
            ctx.beginPath();
            ctx.moveTo(startX + 10, rebarYTopFront); ctx.lineTo(endX - 10, rebarYTopFront);
            ctx.moveTo(startX + 10, rebarYBottomFront); ctx.lineTo(endX - 10, rebarYBottomFront);
            ctx.stroke();
            
            for(let i = 0; i < 5; i++) {
                let stirrupX = startX + 50 + i * (distanceCm * scale / 5);
                ctx.beginPath();
                ctx.moveTo(stirrupX, rebarYTopFront);
                ctx.lineTo(stirrupX, rebarYBottomFront);
                ctx.stroke();
            }

            let crackX = startX + (crackPositionCm * scale);
            if (crackFound) {
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(crackX, sensorY - 30);
                ctx.lineTo(crackX, sensorY + 30);
                ctx.stroke();
                
                ctx.fillStyle = '#000000';
                ctx.font = '12px Inter';
                ctx.fillText(`Flaw: ${crackSize.toFixed(1)}mm`, crackX - 25, sensorY - 40);

                ctx.strokeStyle = 'rgba(245, 158, 11, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([6, 4]);
                ctx.beginPath();
                ctx.moveTo(startX, sensorY);
                ctx.quadraticCurveTo(crackX, sensorY - 40, endX, sensorY); 
                ctx.stroke();
                ctx.setLineDash([]);
            }

            ctx.strokeStyle = crackFound ? 'rgba(55, 65, 81, 0.4)' : '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(startX, sensorY);
            ctx.lineTo(endX, sensorY);
            ctx.stroke();

            if (animationProgress > 0) {
                
                const detourMultiplier = crackFound ? 1.15 : 1.0; 
                const normalizedProgress = animationProgress / (distanceCm * detourMultiplier * 5); 
                const t = Math.min(normalizedProgress, 1.0);
                
                let waveCenter;
                if (crackFound) {
                    const P0 = {x: startX, y: sensorY};
                    const P1 = {x: crackX, y: sensorY - 40};
                    const P2 = {x: endX, y: sensorY};

                    waveCenter = {
                        x: Math.pow(1 - t, 2) * P0.x + 2 * (1 - t) * t * P1.x + Math.pow(t, 2) * P2.x,
                        y: Math.pow(1 - t, 2) * P0.y + 2 * (1 - t) * t * P1.y + Math.pow(t, 2) * P2.y
                    };

                } else {
                    waveCenter = {
                        x: startX + (endX - startX) * t,
                        y: sensorY
                    };
                }
                
                for (let i = 0; i < 4; i++) {
                    const ringOffset = (animationProgress * 0.15) % 100;
                    const ringRadius = 10 + ringOffset + i * 20; 
                    
                    const opacityFactor = Math.max(0, 1.0 - (ringRadius / (W * 0.8))); 
                    const color = crackFound ? `rgba(255, 0, 0, ${opacityFactor * 0.8})` : `rgba(0, 150, 0, ${opacityFactor * 0.8})`;

                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1 + opacityFactor * 2;
                    ctx.beginPath();
                    ctx.arc(startX, sensorY, ringRadius * (distanceCm / maxDistance), 0, Math.PI * 2);
                    ctx.stroke();
                }

                const pulse = Math.sin(animationProgress * 0.2); 
                const waveRadius = 10 + pulse * 4; 
                const waveColor = crackFound ? '#ef4444' : '#10b981';
                
                ctx.fillStyle = waveColor;
                ctx.beginPath();
                ctx.arc(waveCenter.x, waveCenter.y, waveRadius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(waveCenter.x, waveCenter.y, waveRadius * 0.4, 0, Math.PI * 2);
                ctx.fill();

                if (t >= 1.0) {
                    if (Math.abs(waveCenter.x - endX) < 5 && Math.abs(waveCenter.y - sensorY) < 5) {
                        stopWaveAnimation();
                        const currentTOF = crackFound ? detourPathTOF : directPathTOF;
                        const finalMsg = crackFound ? 'RECEIVED (Detour Path)' : 'RECEIVED (Direct Path)';
                        if (coverageStatusEl) coverageStatusEl.textContent = `Analysis Complete: ${finalMsg}. Measured TOF: ${currentTOF} μs`;
                    }
                }
            }

            const sensorRadius = 6;
            
            const tX = startX;
            ctx.fillStyle = '#2563eb'; 
            ctx.beginPath();
            ctx.arc(tX, sensorY, sensorRadius, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#1e3a8a';
            ctx.font = '14px Inter';
            ctx.fillText('T', tX - 3, sensorY - 15);

            const rX = endX;
            ctx.fillStyle = '#dc2626'; 
            ctx.beginPath();
            ctx.arc(rX, sensorY, sensorRadius, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#991b1b';
            ctx.fillText('R', rX - 3, sensorY - 15);
        }


        // --- Diagnosis Logic (Retained) ---
        function runDiagnosis() {
            const symptom = document.getElementById('symptom-select').value;
            const titleEl = document.getElementById('diagnosis-title');
            const causeEl = document.getElementById('diagnosis-cause');
            const actionEl = document.getElementById('diagnosis-action');
            const btn = document.getElementById('diagnosis-btn');

            let title, cause, action;

            switch (symptom) {
                case 'wave_delay':
                    title = "Internal Crack or Delamination Suspected";
                    cause = "The prolonged Time of Flight (TOF) indicates the wave traveled a longer, diffracted path around an internal crack or air-filled void.";
                    action = "Action: Increase sensor density around the measurement area. Use the AI Classifier for a definitive prognosis. Prioritize non-contact visual inspection (drone/camera) of the external surface.";
                    break;
                case 'attenuation':
                    title = "Microcracking or High Void Content Detected";
                    cause = "Excessive signal attenuation (loss of amplitude) suggests a high concentration of microcracks or excessive porosity within the concrete section.";
                    action = "Action: Perform material sampling (core drill) for lab testing. Reduce external loading on the element temporarily. Monitor Pulse Velocity (PV) trend closely.";
                    break;
                case 'echoes':
                    title = "Internal Voids or Honeycombing Confirmed";
                    cause = "Multiple reflections and scattering indicate the wave is encountering large internal boundaries, likely honeycombing or severe internal voids (poor compaction).";
                    action = "Action: Use Ground Penetrating Radar (GPR) to map void locations. Plan injection of high-strength epoxy resin into the affected zone for stabilization.";
                    break;
                case 'low_pv':
                    title = "Substandard Concrete Strength/Quality";
                    cause = "The Pulse Velocity (PV) is below the minimum threshold, suggesting weak concrete or severe widespread degradation (e.g., alkali-aggregate reaction or poor mix grade).";
                    action = "Action: Perform Rebound Hammer test and core drilling for compressive strength testing. Plan for partial or full structural replacement if compressive strength is below design limits.";
                    break;
                case 'loss':
                    title = "Severe Discontinuity/Full Blockage";
                    cause = "Total loss of the ultrasonic signal indicates a complete barrier to the wave path, likely a massive internal crack, large water pocket, or a severe material discontinuity.";
                    action = "Action: IMMEDIATELY isolate the structural element (if critical). Re-position transducers using the indirect method for confirmation. Schedule immediate engineering assessment.";
                    break;
                default:
                    title = "Select an Anomaly";
                    cause = "Awaiting Simulation...";
                    action = "Select an anomaly and click 'Run AI Signal Analysis' to see immediate mitigation steps.";
            }

            if (titleEl) titleEl.textContent = title;
            if (causeEl) causeEl.innerHTML = cause;
            if (actionEl) actionEl.textContent = action;
            
            if (btn) {
                btn.classList.add('neumorphic-pressed');
                setTimeout(() => { btn.classList.remove('neumorphic-pressed'); }, 300);
            }
            showNotification(`Diagnosis complete for: ${symptom.replace('_', ' ')}!`);
        }

        // --- Planner Logic (Retained) ---
        const structPlans = {
            pillar: {
                low: "Routine Inspection (Quarterly)",
                moderate: "Non-Critical Repair Schedule (Next 6 Months)",
                high: "Urgent Repair/Monitoring (Next 30 Days)",
                critical: "Immediate Closure and Stabilization"
            },
            beam: {
                low: "Routine Inspection (Quarterly)",
                moderate: "Non-Critical Repair Schedule (Next 6 Months)",
                high: "Urgent Repair/Monitoring (Next 30 Days)",
                critical: "Immediate Closure and Stabilization"
            },
            slab: {
                low: "Routine Inspection (Annual)",
                moderate: "Surface Treatment/Patching (Next 3 Months)",
                high: "Deep Penetrating Repair/GPR Scan (Next 14 Days)",
                critical: "Immediate Lane/Area Closure and Replacement Planning"
            },
            foundation: {
                low: "Routine Inspection (Biannual)",
                moderate: "Monitor Settlement/Tilt Sensors (Monthly)",
                high: "Geotechnical Investigation & Underpinning Plan (Next 30 Days)",
                critical: "Emergency Load Reduction & Structural Review"
            }
        };

        const planTasks = {
            low: [
                "1. Document NDT readings in the central database.",
                "2. Recalibrate sensors (annual procedure).",
                "3. Perform visual inspection for new surface defects."
            ],
            moderate: [
                "1. Increase ultrasonic testing frequency (monthly).",
                "2. Conduct core sampling for compressive strength check.",
                "3. Prepare budget for non-critical epoxy injection."
            ],
            high: [
                "1. IMMEDIATE GPR scanning to confirm crack depth/void location.",
                "2. Schedule epoxy injection or crack stitching in the next 30 days.",
                "3. Review structural calculations for current load limits."
            ],
            critical: [
                "1. IMMEDIATE load diversion/element isolation.",
                "2. Conduct full structural investigation and load testing.",
                "3. Initiate design process for partial or full replacement."
            ]
        };

        function viewStructurePlan() {
            const component = document.getElementById('component-select').value;
            const risk = document.getElementById('risk-select').value;
            const titleEl = document.getElementById('planner-component-title');
            const priorityEl = document.getElementById('planner-priority');
            const tasksUl = document.getElementById('planner-tasks');
            const btn = document.getElementById('planner-btn');

            const componentName = document.getElementById('component-select').options[document.getElementById('component-select').selectedIndex].text;
            const planText = structPlans[component][risk];
            const tasks = planTasks[risk];
            
            if (titleEl) titleEl.textContent = `${componentName} - Maintenance Plan`;
            if (priorityEl) priorityEl.textContent = planText;
            
            let priorityColor = '';
            if (risk === 'critical') priorityColor = 'text-red-700';
            else if (risk === 'high') priorityColor = 'text-orange-700';
            else if (risk === 'moderate') priorityColor = 'text-yellow-700';
            else priorityColor = 'text-blue-700';
            
            if (priorityEl) {
                priorityEl.className = 'text-xl font-bold';
                priorityEl.classList.add(priorityColor);
            }

            if (tasksUl) {
                tasksUl.innerHTML = '';
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.textContent = task;
                    tasksUl.appendChild(li);
                });
            }

            if (btn) {
                btn.classList.add('neumorphic-pressed');
                setTimeout(() => { btn.classList.remove('neumorphic-pressed'); }, 300);
            }
            showNotification(`Maintenance plan generated for ${componentName} (${risk}).`);
        }
        
        // --- Chatbot Logic (Retained) ---
        function generateAIResponse(query) {
            const lowerQuery = query.toLowerCase();

            if (lowerQuery.includes('tof') || lowerQuery.includes('time of flight')) {
                return "Time of Flight (TOF) is the time it takes for the ultrasonic pulse to pass through the concrete. A **high TOF** suggests the wave took a longer path, typically indicating a crack, void, or material discontinuity in the straight path.";
            } else if (lowerQuery.includes('pv') || lowerQuery.includes('pulse velocity')) {
                return "Pulse Velocity (PV) is calculated by dividing the path distance by the TOF. A **low PV** means the concrete is likely of lower density or has internal deterioration, often due to microcracks or weak cement paste.";
            } else if (lowerQuery.includes('crack') || lowerQuery.includes('void')) {
                return "For crack detection, the AI analyzes signal frequency and amplitude changes (scalograms). A sudden drop in wave velocity or high attenuation confirms internal flaw presence. Please use the 'Crack Diagnosis' simulator for specific symptoms.";
            } else if (lowerQuery.includes('gpr') || lowerQuery.includes('radar')) {
                return "Ground Penetrating Radar (GPR) is an excellent complementary NDT method. While ultrasonics detect wave disruptions, GPR is better for mapping rebar locations, tendon ducts, and large, near-surface voids in concrete.";
            } else if (lowerQuery.includes('thank') || lowerQuery.includes('great')) {
                return "You're very welcome! Ensuring structural safety is critical. Feel free to ask anything else about NDT or your project.";
            } else {
                return "That's a complex SHM query! My training covers NDT methods, ultrasonic principles, and AI classification. Is your question about **TOF, Pulse Velocity, or AI processing?";
            }
        }

        function handleChatSubmit(e) {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');
            const userQuery = chatInput.value.trim();

            if (!userQuery) return;

            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'user-message p-3 shadow-md';
            userMsgDiv.innerHTML = `<p class="font-semibold text-sm mb-1">You:</p><p>${userQuery}</p>`;
            if (chatWindow) chatWindow.appendChild(userMsgDiv);

            if (chatInput) chatInput.value = '';
            if (chatInput) chatInput.disabled = true;

            const loadingMsgDiv = document.createElement('div');
            loadingMsgDiv.className = 'ai-message p-3 shadow-md';
            loadingMsgDiv.innerHTML = `<p class="font-semibold text-sm mb-1 text-blue-700">InfraScan AI:</p><p id="loading-dots">...</p>`;
            if (chatWindow) chatWindow.appendChild(loadingMsgDiv);
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;	

            setTimeout(() => {
                const aiResponse = generateAIResponse(userQuery);
                
                loadingMsgDiv.innerHTML = `<p class="font-semibold text-sm mb-1 text-blue-700">InfraScan AI:</p><p>${aiResponse}</p>`;
                
                if (chatInput) chatInput.disabled = false;
                if (chatInput) chatInput.focus();
                if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
                
            }, 1500);
        }

        // --- Optimization Logic (Retained) ---
        const totalBudget = 100; 
        const optimalSplit = { density: 50, ai: 30, manual: 20 }; 
        const mockCostSavingsBase = 100000; 

        function updateAllocation() {
            const density = parseInt(document.getElementById('budget-density').value);
            const ai = parseInt(document.getElementById('budget-ai').value);
            const manual = parseInt(document.getElementById('budget-manual').value);
            const used = density + ai + manual;
            const remaining = totalBudget - used;

            const valDensity = document.getElementById('val-density');
            const valAi = document.getElementById('val-ai');
            const valManual = document.getElementById('val-manual');
            
            if (valDensity) valDensity.textContent = `${density}%`;
            if (valAi) valAi.textContent = `${ai}%`;
            if (valManual) valManual.textContent = `${manual}%`;

            const remainingEl = document.getElementById('remaining-budget');
            const optimizeBtn = document.getElementById('optimize-btn');
            
            if (remainingEl && optimizeBtn) {
                remainingEl.textContent = `${remaining}%`;
                
                if (remaining < 0) {
                    remainingEl.classList.remove('text-yellow-600');
                    remainingEl.classList.add('text-red-600');
                    optimizeBtn.disabled = true;
                    remainingEl.textContent = `OVER budget by ${Math.abs(remaining)}%`;
                } else {
                    remainingEl.classList.remove('text-red-600');
                    remainingEl.classList.add('text-yellow-600');
                    optimizeBtn.disabled = false;
                }
            }
        }
        
        document.getElementById('optimization-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const density = parseInt(document.getElementById('budget-density').value);
            const ai = parseInt(document.getElementById('budget-ai').value);
            const manual = parseInt(document.getElementById('budget-manual').value);

            if (density + ai + manual > totalBudget) {
                showNotification("Error: Budget exceeded! Please allocate a total of 100% or less.");
                return;
            }

            const densityDev = Math.abs(density - optimalSplit.density) / optimalSplit.density;
            const aiDev = Math.abs(ai - optimalSplit.ai) / optimalSplit.ai;
            const manualDev = Math.abs(manual - optimalSplit.manual) / optimalSplit.manual;
            
            const totalDeviation = (densityDev * 0.5) + (aiDev * 0.3) + (manualDev * 0.2); 
            const overallEfficiency = Math.max(1.0 - Math.min(totalDeviation, 1.0), 0); 

            const detectionAccuracy = Math.max(Math.round(95 * overallEfficiency * 0.8 + 15), 50); 
            const costSavings = Math.round(mockCostSavingsBase * overallEfficiency * 0.8 + 20000); 
            const inspectionTimeReduction = Math.round(75 * overallEfficiency);
            const anomalyRate = Math.round(detectionAccuracy * (1 - (manual / 100))); 
            
            const optAccuracy = document.getElementById('opt-accuracy');
            const optSavings = document.getElementById('opt-savings');
            const optReduction = document.getElementById('opt-reduction');
            const optRate = document.getElementById('opt-rate');

            if (optAccuracy) optAccuracy.textContent = `${detectionAccuracy}%`;
            if (optSavings) optSavings.textContent = `₹ ${costSavings.toLocaleString()}`;
            if (optReduction) optReduction.textContent = `${inspectionTimeReduction}%`;
            if (optRate) optRate.textContent = `${anomalyRate}%`;

            const visDensityBar = document.getElementById('vis-density-bar');
            const visAiBar = document.getElementById('vis-ai-bar');
            const visManualBar = document.getElementById('vis-manual-bar');

            if (visDensityBar) visDensityBar.style.width = `${density}%`;
            if (visAiBar) visAiBar.style.width = `${ai}%`;
            if (visManualBar) visManualBar.style.width = `${manual}%`;

            let message = '';
            if (detectionAccuracy >= 90) {
                message = "🎯 MASTER ALLOCATION! Near-perfect balance for maximum efficiency and accuracy.";
            } else if (detectionAccuracy >= 80) {
                message = "✅ Excellent Allocation! High accuracy, but slight improvement possible in density/AI split.";
            } else if (detectionAccuracy >= 70) {
                message = "⚠️ Moderate Performance. Check that Sensor Density (50%) is the highest allocation.";
            } else {
                message = "🛑 Low Accuracy. Your allocation heavily favors manual work, reducing the benefit of the automated system.";
            }

            const optMessage = document.getElementById('opt-message');
            if (optMessage) optMessage.innerHTML = message;

            const button = document.getElementById('optimize-btn');
            if (button) {
                button.classList.add('neumorphic-pressed');
                setTimeout(() => { button.classList.remove('neumorphic-pressed'); }, 300);
            }
            showNotification(`Efficiency calculation complete. Accuracy: ${detectionAccuracy}%.`);
        });

        // --- Scalogram Simulation (Retained) ---
        function generateScalogram() {
            const signalType = document.getElementById('signal-type').value;
            const visualEl = document.getElementById('scalogram-visual');
            const predictionEl = document.getElementById('ai-prediction');
            const confidenceEl = document.getElementById('ai-confidence');

            let prediction, confidence, color, visualText;

            switch (signalType) {
                case 'healthy':
                    prediction = "Condition: HEALTHY CONCRETE";
                    confidence = 98.5;
                    color = 'text-green-600';
                    visualText = "Clean, focused wave energy map.";
                    break;
                case 'microcrack':
                    prediction = "Condition: MICROCRACK DETECTED";
                    confidence = 87.2;
                    color = 'text-yellow-600';
                    visualText = "Scattered, delayed high-frequency components.";
                    break;
                case 'severe':
                    prediction = "Condition: SEVERE FLAW/VOID";
                    confidence = 94.1;
                    color = 'text-red-600';
                    visualText = "Major signal loss and energy scattering.";
                    break;
                default:
                    return;
            }

            if (visualEl) visualEl.textContent = `Scalogram View: ${visualText}`;
            if (predictionEl) {
                predictionEl.textContent = prediction;
                predictionEl.classList.remove('text-purple-600', 'text-green-600', 'text-yellow-600', 'text-red-600');
                predictionEl.classList.add(color);
            }
            if (confidenceEl) confidenceEl.textContent = `AI Confidence: ${confidence.toFixed(1)}% (VGG16/MobileNetV2)`;

            showNotification(prediction);
        }

        // --- Initialization ---

        document.getElementById('chat-form').addEventListener('submit', handleChatSubmit);
        document.getElementById('instant-metrics-form').addEventListener('submit', runInstantSimulation);

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // 1. Initialize Default Scenario
            loadCoverageScenario('healthy');
            
            // 2. Initialize the Library tab content
            const ultrasonicTab = document.getElementById('tab-ultrasonic');
            if (ultrasonicTab) {
                setLibraryContent('ultrasonic', ultrasonicTab);
            }
            
            // 3. Initialize Planner and Optimization views
            viewStructurePlan();
            updateAllocation();

            // 4. Initial Scalogram/Prediction state
            const aiPrediction = document.getElementById('ai-prediction');
            const aiConfidence = document.getElementById('ai-confidence');
            const scalogramVisual = document.getElementById('scalogram-visual');

            if (aiPrediction) {
                aiPrediction.textContent = "Awaiting Analysis...";
                aiPrediction.classList.add('text-purple-600');
            }
            if (aiConfidence) aiConfidence.textContent = "Confidence: 0%";
            if (scalogramVisual) scalogramVisual.textContent = "Simulated Scalogram Image / Time-Frequency Map";

            // 5. Set initial view to Dashboard
            const dashboardLink = document.querySelector('.sidebar-link[data-view-id="dashboard"]');
            if (dashboardLink) {
                showView('dashboard', dashboardLink);
            }
        });
    </script>
</body>
</html>
